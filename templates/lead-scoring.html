<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Scoring - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        window.backendSearchSeed = {{ search_seed | tojson }};
    </script>
</head>


<body id="page-scoring">
    <aside class="sidebar">
        <h2>CRM Admin</h2>
        <a href="/dashboard" class="nav-link nav-dashboard">Dashboard</a>
        <a href="/customers" class="nav-link nav-customers">Customer List</a>
        <a href="/templates-manager" class="nav-link nav-templates">Template Manager</a>
        <a href="/history" class="nav-link nav-history">Chat History</a>
        <a href="/repository" class="nav-link nav-repository">Inquiry Repository</a>
        <a href="/scoring" class="nav-link nav-scoring active">Lead Scoring</a>
    </aside>

    <main class="main">
        <div class="header">
            <div class="header-left">
                <h1 class="h3 mb-0">Lead Scoring Rules</h1>
            </div>
            <div class="search-container">
                <input type="text" placeholder="Search leads, rules, or customers..." class="taskbar-search">
            </div>
            <div class="header-right">
                <a href="{{ url_for('add_rule') }}" class="btn btn-blue">+ New Rule</a>
            </div>
        </div>

        <div class="row g-3 mb-4 p-3 bg-white border rounded shadow-sm align-items-end">
            <div class="col-md-3">
                <label class="small fw-bold mb-1 d-block">Search:</label>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Find rule name..."
                    onkeyup="applyFilters()">
            </div>
            <div class="col-md-3">
                <label class="small fw-bold mb-1 d-block">Status:</label>
                <select id="filterStatus" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Not Active">Not Active</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold mb-1 d-block">Operation:</label>
                <select id="filterOperation" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">All Ops</option>
                    <option value="+">Add (+)</option>
                    <option value="-">Subtract (-)</option>
                    <option value="*">Multiply (*)</option>
                    <option value="/">Divide (/)</option>
                </select>
            </div>
        </div>

        <div class="card p-0 shadow-sm overflow-hidden">
            <div class="card-header bg-white py-3 fw-bold">Active Automation Rules</div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead class="bg-light small text-uppercase">
                        <tr>
                            <th>Rule Name</th>
                            <th class="text-center">Op</th>
                            <th class="text-center">Value</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ruleTable" class="align-middle">
                        {% if rules|length > 0 %}
                        {% for rule in rules %}
                        <tr>
                            <td class="fw-bold">{{ rule.name }}</td>
                            <td class="text-center">
                                <span class="badge bg-info text-dark">{{ rule.operation }}</span>
                            </td>
                            <td class="text-center fw-bold">{{ rule.score }}</td>
                            <td class="text-center">
                                <div class="status-toggle-container form-check form-switch">
                                    <span class="status-label">{{ 'Active' if rule.active else 'Not Active' }}</span>
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        onchange="toggleStatus('{{ rule.id }}', this)" {% if rule.active %}checked{%
                                        endif %}>
                                </div>
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('edit_rule', id=rule.id) }}" class="text-primary me-3">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_rule', id=rule.id) }}" class="text-danger"
                                    onclick="return confirm('Delete this rule?')">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center p-5 text-muted">No rules found. Click "+ New Rule" to
                                start.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="pagination mt-3 justify-content-center d-flex align-items-center gap-3">
            <button id="page-prev" class="btn btn-sm btn-outline-secondary">Prev</button>
            <div id="page-indicator" class="small fw-bold">Page 1 of 1</div>
            <button id="page-next" class="btn btn-sm btn-outline-secondary">Next</button>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rowsPerPage = 10;
        let currentPage = 1;
        let allRows = [];
        let filteredRows = [];

        function applyFilters(resetPage = true) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const opFilter = document.getElementById('filterOperation').value;

            console.log('Filter values:', { searchTerm, statusFilter, opFilter });

            filteredRows = allRows.filter(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const opText = row.cells[1].innerText.trim();
                // Extract just the symbol from text like "Add (+)" -> "+"
                const opMatch = opText.match(/\(([+\-*/])\)/);
                const op = opMatch ? opMatch[1] : opText;
                const status = row.querySelector('.status-label').innerText.trim();

                console.log('Row data:', { name, op: `${opText} -> ${op}`, status });

                const matchesSearch = name.includes(searchTerm);
                const matchesStatus = (statusFilter === 'all' || status === statusFilter);
                const matchesOp = (opFilter === 'all' || op === opFilter);

                console.log('Matches:', { matchesSearch, matchesStatus, matchesOp });

                return matchesSearch && matchesStatus && matchesOp;
            });

            console.log('Filtered rows count:', filteredRows.length);

            if (resetPage) currentPage = 1;
            updateUI();
        }

        function updateUI() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

            // Hide all rows
            allRows.forEach(row => row.style.display = "none");

            // Show current page slice
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            filteredRows.slice(start, end).forEach(row => row.style.display = "");

            // Update Controls
            document.getElementById("page-indicator").innerHTML = totalPages > 0 ? `Page <b>${currentPage}</b> of <b>${totalPages}</b>` : "No results";
            document.getElementById("page-prev").disabled = (currentPage === 1);
            document.getElementById("page-next").disabled = (currentPage === totalPages || totalPages === 0);
        }

        function toggleStatus(id, checkbox) {
            fetch('/toggle_status/' + id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ active: checkbox.checked })
            }).then(() => {
                const label = checkbox.parentElement.querySelector('.status-label');
                if (label) label.innerText = checkbox.checked ? "Active" : "Not Active";
                applyFilters(false);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const tableBody = document.getElementById("ruleTable");
            allRows = Array.from(tableBody.querySelectorAll("tr")).filter(row => row.cells.length > 1);
            filteredRows = [...allRows];

            document.getElementById("page-prev").onclick = () => { if (currentPage > 1) { currentPage--; updateUI(); } };
            document.getElementById("page-next").onclick = () => { if (currentPage < Math.ceil(filteredRows.length / rowsPerPage)) { currentPage++; updateUI(); } };

            updateUI();
        });
    </script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>