<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat History - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ===== CHAT PAGE SPECIFIC STYLES ===== */
        .chat-page-container {
            display: flex;
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            /* Adaptive height for flex container */
            flex: 1;
            width: 100%;
            height: 100%;
            /* Ensure it fills the parent flex item */
            min-height: 0;
            /* Crucial for nested flex scrolling */
        }

        /* --- Sidebar --- */
        .chat-list-panel {
            width: 320px;
            min-width: 320px;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            background: #fbfcfe;
        }

        .chat-list-header {
            padding: 12px 14px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-view-tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 3px;
        }

        .chat-view-tab {
            flex: 1;
            text-align: center;
            padding: 6px 10px;
            font-size: 0.78rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.15s;
            color: #64748b;
            border: none;
            background: transparent;
        }

        .chat-view-tab.active {
            background: white;
            color: var(--blue);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chat-list-search input {
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            font-size: 0.84rem;
            width: 100%;
            background: white;
        }

        .chat-sort-bar {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-sort-bar select {
            font-size: 0.76rem;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            color: #475569;
            flex: 1;
        }

        .chat-list-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }

        .chat-list-item:hover {
            background: #f0f5ff;
        }

        .chat-list-item.active {
            background: #eef4ff;
            border-left: 4px solid var(--blue);
        }

        .chat-list-item.has-keyword-match {
            background: #fef2f2;
            border-left: 4px solid transparent;
        }

        .chat-list-item.has-keyword-match:hover {
            background: #fee2e2;
        }

        .chat-list-item.has-keyword-match.active {
            background: #fee2e2;
            border-left: 4px solid var(--blue);
        }

        .chat-list-item.has-keyword-match .name-text {
            color: #dc2626;
            font-weight: 700;
        }

        .keyword-flag {
            font-size: 0.75rem;
            color: #dc2626;
            margin-left: 4px;
            font-weight: 700;
        }

        .chat-list-item .chat-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--slate-900);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chat-list-item .chat-preview {
            font-size: 0.78rem;
            color: var(--gray);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item .chat-time {
            font-size: 0.7rem;
            color: #94a3b8;
            position: absolute;
            top: 12px;
            right: 14px;
        }

        .chat-list-item .chat-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dot-bot {
            background: #f59e0b;
        }

        .dot-agent {
            background: #10b981;
        }

        .dot-closed {
            background: #94a3b8;
        }

        .chat-list-item.has-keyword-match {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .chat-list-item.has-keyword-match:hover {
            background: #fee2e2;
        }

        .keyword-flag {
            font-size: 0.6rem;
            background: #fee2e2;
            color: #dc2626;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* --- Session tags in sidebar --- */
        .chat-item-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .chat-tag-pill {
            font-size: 0.62rem;
            padding: 1px 7px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .tag-impt {
            background: #fef2f2;
            color: #dc2626;
        }

        .tag-waiting {
            background: #fffbeb;
            color: #d97706;
        }

        .tag-completed {
            background: #ecfdf5;
            color: #059669;
        }

        .tag-follow-up {
            background: #eff6ff;
            color: #2563eb;
        }

        .pin-icon {
            font-size: 0.72rem;
            color: #f59e0b;
        }

        /* --- Context menu for chat items --- */
        .chat-item-menu {
            position: absolute;
            top: 8px;
            right: 36px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .chat-list-item:hover .chat-item-menu {
            opacity: 1;
        }

        .chat-item-menu-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.72rem;
            color: #64748b;
        }

        .chat-item-menu-btn:hover {
            background: #e2e8f0;
        }

        /* --- Dropdown context menu --- */
        .ctx-menu {
            position: fixed;
            z-index: 3000;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 6px 0;
            min-width: 180px;
        }

        .ctx-menu-item {
            padding: 8px 16px;
            font-size: 0.82rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.1s;
        }

        .ctx-menu-item:hover {
            background: #f1f5f9;
        }

        .ctx-menu-item.danger {
            color: #dc2626;
        }

        .ctx-menu-item.danger:hover {
            background: #fef2f2;
        }

        .ctx-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        /* --- Main Chat Panel --- */
        .chat-main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header-bar {
            padding: 12px 18px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: var(--blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .chat-header-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--slate-900);
        }

        .chat-header-status {
            font-size: 0.74rem;
            font-weight: 600;
        }

        .chat-header-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chat-messages-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        /* --- Chat bubbles --- */
        .chat-bubble {
            max-width: 72%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.86rem;
            line-height: 1.5;
            position: relative;
            transition: 0.15s;
        }

        .chat-bubble:hover .msg-delete-btn {
            opacity: 1;
        }

        .chat-bubble .bubble-time {
            font-size: 0.66rem;
            color: #94a3b8;
            margin-top: 4px;
            text-align: right;
        }

        .bubble-customer {
            background: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .bubble-bot {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #78350f;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            font-size: 0.82rem;
        }

        .bubble-bot::before {
            content: 'ü§ñ ';
        }

        .bubble-agent {
            background: var(--blue);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .bubble-agent .bubble-time {
            color: rgba(255, 255, 255, 0.65);
        }

        .bubble-system {
            background: #ecfdf5;
            border: 1px dashed #10b981;
            color: #065f46;
            align-self: center;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: 10px;
            max-width: 90%;
        }

        .bubble-keyword-match {
            box-shadow: 0 0 0 2px #ef4444, 0 0 12px rgba(239, 68, 55, 0.2);
        }

        .keyword-highlight {
            background: #fecaca;
            color: #991b1b;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        /* --- Message delete button --- */
        .msg-delete-btn {
            position: absolute;
            top: 4px;
            opacity: 0;
            transition: opacity 0.15s;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.65rem;
            padding: 2px 7px;
            cursor: pointer;
        }

        .msg-delete-btn:hover {
            background: #dc2626;
        }

        .bubble-customer .msg-delete-btn,
        .bubble-bot .msg-delete-btn {
            right: -4px;
            top: -8px;
        }

        .bubble-agent .msg-delete-btn {
            left: -4px;
            top: -8px;
        }

        /* --- Input Area --- */
        .chat-input-bar {
            padding: 12px 18px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
            background: #fafbfc;
        }

        .chat-input-bar input {
            flex: 1;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 9px 14px;
            font-size: 0.88rem;
        }

        .chat-input-bar input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* --- Empty state --- */
        .chat-empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--gray);
        }

        .chat-empty-state h3 {
            font-size: 1.08rem;
            color: var(--slate-900);
            margin-bottom: 6px;
        }

        /* --- Links panel --- */
        .chat-links-panel {
            padding: 10px 18px;
            border-top: 1px solid #e2e8f0;
            background: #f9fafb;
            font-size: 0.8rem;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .chat-link-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #eef4ff;
            color: var(--blue);
            padding: 3px 9px;
            border-radius: 8px;
            font-size: 0.76rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
        }

        .chat-link-badge:hover {
            background: #dbeafe;
        }

        .chat-link-badge.unlinked {
            background: #f1f5f9;
            color: var(--gray);
            border: 1px dashed #cbd5e1;
        }

        /* --- Tags bar in header --- */
        .chat-tags-bar {
            padding: 8px 18px;
            border-bottom: 1px solid #e2e8f0;
            background: #fafbfc;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tag-toggle-btn {
            font-size: 0.72rem;
            padding: 3px 10px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-weight: 600;
            transition: 0.15s;
            background: white;
            color: #64748b;
        }

        .tag-toggle-btn.active-tag-impt {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }

        .tag-toggle-btn.active-tag-waiting {
            background: #fffbeb;
            color: #d97706;
            border-color: #fde68a;
        }

        .tag-toggle-btn.active-tag-completed {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }

        .tag-toggle-btn.active-tag-follow-up {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .tag-toggle-btn:hover {
            border-color: #94a3b8;
        }

        /* --- Takeover overlay --- */
        .takeover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .takeover-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .takeover-card h3 {
            margin: 0 0 10px;
            font-size: 1.12rem;
        }

        .takeover-card p {
            color: var(--gray);
            font-size: 0.86rem;
            margin-bottom: 18px;
        }

        .takeover-card .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* --- Confirm modal --- */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .confirm-card h3 {
            margin: 0 0 10px;
            font-size: 1.1rem;
        }

        .confirm-card p {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 18px;
        }

        .confirm-card .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</head>

<script>
    window.backendSearchSeed = {{ search_seed | tojson }};
    window.ruleKeywords = {{ rule_keywords | tojson }};
</script>

<body id="page-history">
    <aside class="sidebar">
        <h2>CRM Admin</h2>
        <a href="/dashboard" class="nav-link nav-dashboard">Dashboard</a>
        <a href="/customers" class="nav-link nav-customers">Customer List</a>
        <a href="/templates-manager" class="nav-link nav-templates">Template Manager</a>
        <a href="/history" class="nav-link nav-history active">Chat History</a>
        <a href="/repository" class="nav-link nav-repository">Inquiry Repository</a>
        <a href="/scoring" class="nav-link nav-scoring">Lead Scoring</a>
    </aside>

    <main class="main">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">Conversations</h1>
            <div class="search-container">
                <input type="text" placeholder="Search leads, rules, or customers..."
                    class="taskbar-search form-control">
            </div>
        </div>

        <div class="chat-page-container">

            <!-- === LEFT: CHAT LIST === -->
            <div class="chat-list-panel">
                <div class="chat-list-header">
                    <!-- Active / Archived toggle -->
                    <div class="chat-view-tabs">
                        <button class="chat-view-tab {% if current_view == 'active' %}active{% endif %}"
                            onclick="switchView('active')">üí¨ Active</button>
                        <button class="chat-view-tab {% if current_view == 'archived' %}active{% endif %}"
                            onclick="switchView('archived')">üì¶ Archived</button>
                    </div>

                    <!-- Search -->
                    <div class="chat-list-search">
                        <input type="text" id="chatSearchInput" placeholder="Search conversations..."
                            oninput="filterChatList()">
                    </div>

                    <!-- Sort -->
                    <div class="chat-sort-bar">
                        <select id="chatSortSelect" onchange="sortChatList()">
                            <option value="default">üìå Pinned First</option>
                            <option value="newest">üïê Newest First</option>
                            <option value="oldest">üïê Oldest First</option>
                            <option value="name-az">üî§ Name A-Z</option>
                            <option value="name-za">üî§ Name Z-A</option>
                        </select>
                    </div>
                </div>

                <div class="chat-list-scroll" id="chatListScroll">
                    {% for s in sessions %}
                    <div class="chat-list-item {% if loop.first %}active{% endif %} {% if s.is_lead %}has-keyword-match{% endif %}"
                        data-session-id="{{ s.id }}" data-name="{{ s.visitor_name }}"
                        data-pinned="{{ 'true' if s.pinned else 'false' }}" data-tags="{{ s.tags or '' }}"
                        data-status="{{ s.status }}" onclick="selectChat({{ s.id }})">

                        <div class="chat-time">
                            {% if s.chat_messages %}{{ s.chat_messages[-1].timestamp }}{% endif %}
                        </div>

                        <!-- Context menu button -->
                        <div class="chat-item-menu">
                            <button class="chat-item-menu-btn"
                                onclick="event.stopPropagation(); openChatContextMenu(event, {{ s.id }})">‚ãØ</button>
                        </div>

                        <div class="chat-name">
                            <span
                                class="chat-status-dot {% if s.status == 'bot' %}dot-bot{% elif s.status == 'agent_active' %}dot-agent{% else %}dot-closed{% endif %}"></span>
                            {% if s.pinned %}<span class="pin-icon">üìå</span>{% endif %}
                            <span class="name-text">{{ s.visitor_name }}</span>
                            {% if s.is_lead %}
                            <span class="keyword-flag"> ‚ö° Lead ({{ s.calculated_score | int }})</span>
                            {% endif %}
                        </div>

                        <div class="chat-preview">
                            {% if s.chat_messages %}{{ s.chat_messages[-1].text[:55] }}{% if
                            s.chat_messages[-1].text|length > 55 %}...{% endif %}{% endif %}
                        </div>

                        {% if s.tags %}
                        <div class="chat-item-tags">
                            {% for tag in s.tags.split(',') %}
                            {% if tag.strip() %}
                            <span class="chat-tag-pill tag-{{ tag.strip() }}">{{ tag.strip() }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- === RIGHT: CHAT MAIN === -->
            <div class="chat-main-panel" id="chatMainPanel">
                {% if sessions|length > 0 %}
                <!-- Header -->
                <div class="chat-header-bar" id="chatHeaderBar">
                    <div class="chat-header-info">
                        <div class="chat-header-avatar" id="chatAvatar"></div>
                        <div>
                            <div class="chat-header-name" id="chatHeaderName"></div>
                            <div class="chat-header-status" id="chatHeaderStatus"></div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="btn btn-sm btn-gray" onclick="openLinkCustomerModal()" id="btnLinkCustomer">üë§
                            Link</button>
                        <button class="btn btn-sm btn-gray" onclick="openLinkInquiryModal()" id="btnLinkInquiry">üìã
                            Link</button>
                        <button class="btn btn-sm btn-blue" onclick="confirmTakeOver()" id="btnTakeOver">üéß Take
                            Over</button>
                    </div>
                </div>

                <!-- Tags bar -->
                <div class="chat-tags-bar" id="chatTagsBar">
                    <span style="font-size:0.76rem; color:#64748b; font-weight:600;">Tags:</span>
                    <button class="tag-toggle-btn" data-tag="impt" onclick="toggleTag('impt')">üî¥ Important</button>
                    <button class="tag-toggle-btn" data-tag="waiting" onclick="toggleTag('waiting')">üü° Waiting</button>
                    <button class="tag-toggle-btn" data-tag="completed" onclick="toggleTag('completed')">üü¢
                        Completed</button>
                    <button class="tag-toggle-btn" data-tag="follow-up" onclick="toggleTag('follow-up')">üîµ
                        Follow-up</button>
                </div>

                <!-- Links bar -->
                <div class="chat-links-panel" id="chatLinksPanel">
                    <span id="linkedCustomerBadge" class="chat-link-badge unlinked" onclick="openLinkCustomerModal()">üë§
                        No customer linked</span>
                    <span id="linkedInquiryBadge" class="chat-link-badge unlinked" onclick="openLinkInquiryModal()">üìã
                        No inquiry linked</span>
                </div>

                <!-- Messages -->
                <div class="chat-messages-scroll" id="chatMessagesScroll"></div>

                <!-- Input -->
                <div class="chat-input-bar">
                    <input type="text" id="chatMsgInput" placeholder="Take over chat to start typing..." disabled
                        onkeydown="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-blue px-4" id="btnSend" onclick="sendChatMessage()" disabled>Send</button>
                </div>
                {% else %}
                <div class="chat-empty-state">
                    <div>
                        <h3>{% if current_view == 'archived' %}No archived conversations{% else %}No conversations yet{%
                            endif %}</h3>
                        <p>{% if current_view == 'archived' %}Archived chats will appear here.{% else %}Chats will
                            appear here when customers start messaging.{% endif %}</p>
                        {% if current_view == 'archived' %}
                        <a href="/history?view=active" class="btn btn-sm btn-blue">‚Üê Back to Active</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- LINK CUSTOMER MODAL -->
    <div class="modal fade" id="linkCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üë§ Link Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Select a customer to link to this conversation.</p>
                    <select class="form-select" id="linkCustomerSelect">
                        <option value="">-- None --</option>
                        {% for c in customers %}
                        <option value="{{ c.id }}">{{ c.name }} ({{ c.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-blue" onclick="linkCustomer()">Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LINK INQUIRY MODAL -->
    <div class="modal fade" id="linkInquiryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìã Link Inquiry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Select an inquiry to attach to this conversation.</p>
                    <select class="form-select" id="linkInquirySelect">
                        <option value="">-- None --</option>
                        {% for i in inquiries %}
                        <option value="{{ i.id }}">INQ-{{ "%03d"|format(i.id) }}: {{ i.customer }} ({{ i.status }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-blue" onclick="linkInquiry()">Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAKEOVER / CONFIRM OVERLAYS (injected via JS) -->
    <div id="takeoverOverlay" style="display:none;"></div>
    <div id="confirmOverlay" style="display:none;"></div>

    <!-- CONTEXT MENU (injected via JS) -->
    <div id="ctxMenu" class="ctx-menu" style="display:none;"></div>

    <script>
        // ===== STATE =====
        let currentSessionId = null;
        let currentSessionStatus = null;
        let currentSessionTags = [];
        const keywords = window.ruleKeywords || [];
        const currentView = '{{ current_view }}';

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');

            if (sessionId) {
                selectChat(parseInt(sessionId));
                setTimeout(() => {
                    const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
                    if (item) item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            } else {
                const firstItem = document.querySelector('.chat-list-item');
                if (firstItem) {
                    selectChat(parseInt(firstItem.dataset.sessionId));
                }
            }
            markKeywordChats();
        });

        // Close context menu on click outside
        document.addEventListener('click', () => {
            document.getElementById('ctxMenu').style.display = 'none';
        });

        // ===== VIEW SWITCHING =====
        function switchView(view) {
            window.location.href = `/history?view=${view}`;
        }

        // ===== SORT CHAT LIST =====
        function sortChatList() {
            const sort = document.getElementById('chatSortSelect').value;
            const container = document.getElementById('chatListScroll');
            const items = Array.from(container.querySelectorAll('.chat-list-item'));

            items.sort((a, b) => {
                if (sort === 'default') {
                    // Pinned first, then by ID desc
                    const aPinned = a.dataset.pinned === 'true' ? 1 : 0;
                    const bPinned = b.dataset.pinned === 'true' ? 1 : 0;
                    if (bPinned !== aPinned) return bPinned - aPinned;
                    return parseInt(b.dataset.sessionId) - parseInt(a.dataset.sessionId);
                }
                if (sort === 'newest') return parseInt(b.dataset.sessionId) - parseInt(a.dataset.sessionId);
                if (sort === 'oldest') return parseInt(a.dataset.sessionId) - parseInt(b.dataset.sessionId);
                if (sort === 'name-az') return a.dataset.name.localeCompare(b.dataset.name);
                if (sort === 'name-za') return b.dataset.name.localeCompare(a.dataset.name);
                return 0;
            });

            items.forEach(item => container.appendChild(item));
        }

        // ===== MARK SIDEBAR ITEMS WITH KEYWORD MATCHES =====
        function markKeywordChats() {
            document.querySelectorAll('.chat-list-item').forEach(item => {
                const preview = (item.querySelector('.chat-preview')?.textContent || '').toLowerCase();
                for (const kw of keywords) {
                    if (preview.includes(kw)) {
                        item.classList.add('has-keyword-match');
                        if (!item.querySelector('.keyword-flag')) {
                            const flag = document.createElement('span');
                            flag.className = 'keyword-flag';
                            flag.textContent = '‚ö° Lead';
                            item.querySelector('.chat-name').appendChild(flag);
                        }
                        break;
                    }
                }
            });
        }

        // ===== CONTEXT MENU FOR CHAT ITEMS =====
        function openChatContextMenu(e, sessionId) {
            e.preventDefault();
            e.stopPropagation();

            const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            const isPinned = item?.dataset.pinned === 'true';
            const isArchived = currentView === 'archived';

            const menu = document.getElementById('ctxMenu');
            menu.innerHTML = `
                <div class="ctx-menu-item" onclick="pinChat(${sessionId}, ${!isPinned})">
                    ${isPinned ? 'üìå Unpin' : 'üìå Pin to Top'}
                </div>
                <div class="ctx-menu-divider"></div>
                ${isArchived
                    ? `<div class="ctx-menu-item" onclick="archiveChat(${sessionId}, false)">üì§ Unarchive</div>`
                    : `<div class="ctx-menu-item" onclick="archiveChat(${sessionId}, true)">üì¶ Archive</div>`}
                <div class="ctx-menu-divider"></div>
                <div class="ctx-menu-item danger" onclick="confirmDeleteChat(${sessionId})">üóëÔ∏è Delete Chat</div>
            `;

            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';

            // Keep inside viewport
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 8) + 'px';
            if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 8) + 'px';
        }

        // ===== PIN/UNPIN =====
        async function pinChat(sessionId, pinned) {
            await fetch(`/api/chat/session/${sessionId}/pin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pinned })
            });
            location.reload();
        }

        // ===== ARCHIVE/UNARCHIVE =====
        async function archiveChat(sessionId, archived) {
            await fetch(`/api/chat/session/${sessionId}/archive`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ archived })
            });
            location.reload();
        }

        // ===== DELETE CHAT =====
        function confirmDeleteChat(sessionId) {
            const overlay = document.getElementById('confirmOverlay');
            overlay.style.display = 'flex';
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-card">
                    <h3>üóëÔ∏è Delete Chat</h3>
                    <p>This will permanently delete this conversation and all its messages. This action cannot be undone.</p>
                    <div class="btn-group">
                        <button class="btn btn-gray" onclick="document.getElementById('confirmOverlay').style.display='none'">Cancel</button>
                        <button class="btn btn-sm" style="background:#dc2626;color:white;" onclick="deleteChat(${sessionId})">Delete</button>
                    </div>
                </div>
            `;
        }

        async function deleteChat(sessionId) {
            document.getElementById('confirmOverlay').style.display = 'none';
            await fetch(`/api/chat/session/${sessionId}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            location.reload();
        }

        // ===== SELECT CHAT =====
        async function selectChat(sessionId) {
            currentSessionId = sessionId;

            // Update sidebar active state
            document.querySelectorAll('.chat-list-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            if (activeItem) activeItem.classList.add('active');

            // Fetch messages
            const res = await fetch(`/api/chat/session/${sessionId}/messages`);
            const data = await res.json();
            currentSessionStatus = data.session.status;

            // Parse tags
            currentSessionTags = (data.session.tags || '').split(',').filter(t => t.trim());
            updateTagButtons();

            // Update header
            const name = data.session.visitor_name;
            const parts = name.trim().split(' ');
            const initials = parts[0][0] + (parts.length > 1 ? parts[parts.length - 1][0] : '');
            document.getElementById('chatAvatar').textContent = initials.toUpperCase();
            document.getElementById('chatHeaderName').textContent = name;

            // Status
            const statusEl = document.getElementById('chatHeaderStatus');
            if (data.session.status === 'bot') {
                statusEl.innerHTML = '<span style="color:#f59e0b;">ü§ñ Chatbot Active</span>';
            } else if (data.session.status === 'agent_active') {
                statusEl.innerHTML = '<span style="color:#10b981;">üü¢ Agent Active</span>';
            } else {
                statusEl.innerHTML = '<span style="color:#94a3b8;">‚ö™ Closed</span>';
            }

            // Take over button
            const btnTakeOver = document.getElementById('btnTakeOver');
            if (data.session.status === 'agent_active') {
                btnTakeOver.disabled = true;
                btnTakeOver.textContent = '‚úÖ Taken Over';
                btnTakeOver.classList.replace('btn-blue', 'btn-gray');
            } else {
                btnTakeOver.disabled = false;
                btnTakeOver.textContent = 'üéß Take Over';
                btnTakeOver.classList.replace('btn-gray', 'btn-blue');
            }

            // Enable/disable input
            const msgInput = document.getElementById('chatMsgInput');
            const btnSend = document.getElementById('btnSend');
            if (data.session.status === 'agent_active') {
                msgInput.disabled = false;
                msgInput.placeholder = 'Type your message...';
                btnSend.disabled = false;
            } else {
                msgInput.disabled = true;
                msgInput.placeholder = 'Take over chat to start typing...';
                btnSend.disabled = true;
            }

            // Update linked badges
            updateLinkedBadges(data.session);

            // Render messages
            renderMessages(data.messages);

            // Check keyword matches for sidebar highlighting
            checkKeywordMatchForSession(sessionId, data.messages);
        }

        // ===== TAG MANAGEMENT =====
        function updateTagButtons() {
            document.querySelectorAll('.tag-toggle-btn').forEach(btn => {
                const tag = btn.dataset.tag;
                btn.className = 'tag-toggle-btn';
                if (currentSessionTags.includes(tag)) {
                    btn.classList.add('active-tag-' + tag);
                }
            });
        }

        async function toggleTag(tag) {
            if (!currentSessionId) return;

            const idx = currentSessionTags.indexOf(tag);
            if (idx >= 0) {
                currentSessionTags.splice(idx, 1);
            } else {
                currentSessionTags.push(tag);
            }

            updateTagButtons();

            const tagsStr = currentSessionTags.join(',');
            await fetch(`/api/chat/session/${currentSessionId}/tags`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: tagsStr })
            });

            // Update sidebar item tags
            const sidebarItem = document.querySelector(`.chat-list-item[data-session-id="${currentSessionId}"]`);
            if (sidebarItem) {
                sidebarItem.dataset.tags = tagsStr;
                let tagsDiv = sidebarItem.querySelector('.chat-item-tags');
                if (!tagsDiv) {
                    tagsDiv = document.createElement('div');
                    tagsDiv.className = 'chat-item-tags';
                    sidebarItem.appendChild(tagsDiv);
                }
                tagsDiv.innerHTML = currentSessionTags
                    .map(t => `<span class="chat-tag-pill tag-${t}">${t}</span>`)
                    .join('');
            }
        }

        // ===== RENDER MESSAGES =====
        function renderMessages(messages) {
            const container = document.getElementById('chatMessagesScroll');
            container.innerHTML = '';

            messages.forEach(msg => {
                const div = document.createElement('div');
                let bubbleClass = 'bubble-customer';
                if (msg.sender_type === 'bot') bubbleClass = 'bubble-bot';
                else if (msg.sender_type === 'agent') bubbleClass = 'bubble-agent';
                else if (msg.sender_type === 'system') bubbleClass = 'bubble-system';

                div.className = `chat-bubble ${bubbleClass}`;
                div.dataset.msgId = msg.id;

                // Check for keyword matches in customer messages
                let textHtml = escapeHtml(msg.text);
                let hasMatch = false;
                if (msg.sender_type === 'customer') {
                    const lowerText = msg.text.toLowerCase();
                    for (const kw of keywords) {
                        if (lowerText.includes(kw)) {
                            hasMatch = true;
                            const regex = new RegExp(`(${escapeRegex(kw)})`, 'gi');
                            textHtml = textHtml.replace(regex, '<span class="keyword-highlight">$1</span>');
                        }
                    }
                }

                if (hasMatch) div.classList.add('bubble-keyword-match');

                // Delete button for agent and customer messages
                let deleteBtn = '';
                if (msg.sender_type === 'agent' || msg.sender_type === 'customer') {
                    deleteBtn = `<button class="msg-delete-btn" onclick="deleteMessage(${msg.id}, this)" title="Delete message">‚úï</button>`;
                }

                div.innerHTML = `
                    ${deleteBtn}
                    <div>${textHtml}</div>
                    ${msg.sender_type !== 'system' ? `<div class="bubble-time">${msg.timestamp || ''}</div>` : ''}
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        // ===== DELETE MESSAGE =====
        async function deleteMessage(msgId, btnEl) {
            if (!confirm('Delete this message?')) return;

            const res = await fetch(`/api/chat/message/${msgId}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();

            if (data.ok) {
                // Remove bubble from DOM
                const bubble = btnEl.closest('.chat-bubble');
                bubble.style.transition = 'opacity 0.3s, transform 0.3s';
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0.8)';
                setTimeout(() => bubble.remove(), 300);
            } else {
                alert(data.error || 'Cannot delete this message.');
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ===== CHECK KEYWORD MATCH FOR SIDEBAR =====
        function checkKeywordMatchForSession(sessionId, messages) {
            const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            if (!item) return;

            let found = false;
            for (const msg of messages) {
                if (msg.sender_type === 'customer') {
                    const lower = msg.text.toLowerCase();
                    for (const kw of keywords) {
                        if (lower.includes(kw)) { found = true; break; }
                    }
                }
                if (found) break;
            }

            if (found) {
                item.classList.add('has-keyword-match');
                if (!item.querySelector('.keyword-flag')) {
                    const flag = document.createElement('span');
                    flag.className = 'keyword-flag';
                    flag.textContent = ' ‚ö° Lead';
                    item.querySelector('.chat-name').appendChild(flag);
                }
            }
        }

        // ===== SEND MESSAGE =====
        async function sendChatMessage() {
            const input = document.getElementById('chatMsgInput');
            const text = input.value.trim();
            if (!text || !currentSessionId || currentSessionStatus !== 'agent_active') return;

            input.value = '';

            const res = await fetch(`/api/chat/session/${currentSessionId}/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            if (data.ok) {
                const container = document.getElementById('chatMessagesScroll');
                const div = document.createElement('div');
                div.className = 'chat-bubble bubble-agent';
                div.dataset.msgId = data.message.id;
                div.innerHTML = `
                    <button class="msg-delete-btn" onclick="deleteMessage(${data.message.id}, this)" title="Delete message">‚úï</button>
                    <div>${escapeHtml(data.message.text)}</div>
                    <div class="bubble-time">${data.message.timestamp}</div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }
        }

        // ===== TAKE OVER CHAT =====
        function confirmTakeOver() {
            if (currentSessionStatus === 'agent_active') return;

            const overlay = document.getElementById('takeoverOverlay');
            overlay.style.display = 'flex';
            overlay.className = 'takeover-overlay';
            overlay.innerHTML = `
                <div class="takeover-card">
                    <h3>üéß Take Over Chat</h3>
                    <p>This will notify the customer that a human agent has joined the conversation. The chatbot will stop responding.</p>
                    <div class="btn-group">
                        <button class="btn btn-gray" onclick="cancelTakeOver()">Cancel</button>
                        <button class="btn btn-blue" onclick="executeTakeOver()">Confirm Take Over</button>
                    </div>
                </div>
            `;
        }

        function cancelTakeOver() {
            document.getElementById('takeoverOverlay').style.display = 'none';
        }

        async function executeTakeOver() {
            document.getElementById('takeoverOverlay').style.display = 'none';

            const res = await fetch(`/api/chat/session/${currentSessionId}/takeover`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();

            if (data.ok) {
                currentSessionStatus = 'agent_active';

                const container = document.getElementById('chatMessagesScroll');
                const div = document.createElement('div');
                div.className = 'chat-bubble bubble-system';
                div.innerHTML = `<div>${escapeHtml(data.message.text)}</div>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;

                document.getElementById('chatHeaderStatus').innerHTML = '<span style="color:#10b981;">üü¢ Agent Active</span>';
                const btnTakeOver = document.getElementById('btnTakeOver');
                btnTakeOver.disabled = true;
                btnTakeOver.textContent = '‚úÖ Taken Over';
                btnTakeOver.classList.replace('btn-blue', 'btn-gray');

                document.getElementById('chatMsgInput').disabled = false;
                document.getElementById('chatMsgInput').placeholder = 'Type your message...';
                document.getElementById('chatMsgInput').focus();
                document.getElementById('btnSend').disabled = false;

                const sidebarItem = document.querySelector(`.chat-list-item[data-session-id="${currentSessionId}"]`);
                if (sidebarItem) {
                    const dot = sidebarItem.querySelector('.chat-status-dot');
                    dot.className = 'chat-status-dot dot-agent';
                }
            }
        }

        // ===== LINK CUSTOMER =====
        function openLinkCustomerModal() {
            const modal = new bootstrap.Modal(document.getElementById('linkCustomerModal'));
            modal.show();
        }

        async function linkCustomer() {
            const select = document.getElementById('linkCustomerSelect');
            const customerId = select.value ? parseInt(select.value) : null;

            await fetch(`/api/chat/session/${currentSessionId}/link-customer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customer_id: customerId })
            });

            const badge = document.getElementById('linkedCustomerBadge');
            if (customerId) {
                const name = select.options[select.selectedIndex].text;
                badge.className = 'chat-link-badge';
                badge.textContent = 'üë§ ' + name;
            } else {
                badge.className = 'chat-link-badge unlinked';
                badge.textContent = 'üë§ No customer linked';
            }

            bootstrap.Modal.getInstance(document.getElementById('linkCustomerModal')).hide();
        }

        // ===== LINK INQUIRY =====
        function openLinkInquiryModal() {
            const modal = new bootstrap.Modal(document.getElementById('linkInquiryModal'));
            modal.show();
        }

        async function linkInquiry() {
            const select = document.getElementById('linkInquirySelect');
            const inquiryId = select.value ? parseInt(select.value) : null;

            await fetch(`/api/chat/session/${currentSessionId}/link-inquiry`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inquiry_id: inquiryId })
            });

            const badge = document.getElementById('linkedInquiryBadge');
            if (inquiryId) {
                const label = select.options[select.selectedIndex].text;
                badge.className = 'chat-link-badge';
                badge.textContent = 'üìã ' + label;
            } else {
                badge.className = 'chat-link-badge unlinked';
                badge.textContent = 'üìã No inquiry linked';
            }

            bootstrap.Modal.getInstance(document.getElementById('linkInquiryModal')).hide();
        }

        // ===== UPDATE LINKED BADGES =====
        function updateLinkedBadges(session) {
            const custBadge = document.getElementById('linkedCustomerBadge');
            const inqBadge = document.getElementById('linkedInquiryBadge');

            if (session.linked_customer_id) {
                const select = document.getElementById('linkCustomerSelect');
                const opt = select.querySelector(`option[value="${session.linked_customer_id}"]`);
                if (opt) {
                    custBadge.className = 'chat-link-badge';
                    custBadge.textContent = 'üë§ ' + opt.text;
                    select.value = session.linked_customer_id;
                }
            } else {
                custBadge.className = 'chat-link-badge unlinked';
                custBadge.textContent = 'üë§ No customer linked';
            }

            if (session.linked_inquiry_id) {
                const select = document.getElementById('linkInquirySelect');
                const opt = select.querySelector(`option[value="${session.linked_inquiry_id}"]`);
                if (opt) {
                    inqBadge.className = 'chat-link-badge';
                    inqBadge.textContent = 'üìã ' + opt.text;
                    select.value = session.linked_inquiry_id;
                }
            } else {
                inqBadge.className = 'chat-link-badge unlinked';
                inqBadge.textContent = 'üìã No inquiry linked';
            }
        }

        // ===== SEARCH/FILTER =====
        function filterChatList() {
            const q = document.getElementById('chatSearchInput').value.toLowerCase();
            document.querySelectorAll('.chat-list-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const preview = (item.querySelector('.chat-preview')?.textContent || '').toLowerCase();
                const tags = (item.dataset.tags || '').toLowerCase();
                item.style.display = (name.includes(q) || preview.includes(q) || tags.includes(q)) ? '' : 'none';
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>