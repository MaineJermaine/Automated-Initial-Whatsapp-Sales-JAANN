<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat History - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ===== CHAT PAGE SPECIFIC STYLES ===== */
        .chat-page-container {
            display: flex;
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            /* Adaptive height for flex container */
            flex: 1;
            width: 100%;
            height: 100%;
            /* Ensure it fills the parent flex item */
            min-height: 0;
            /* Crucial for nested flex scrolling */
        }

        /* --- Sidebar --- */
        .chat-list-panel {
            width: 320px;
            min-width: 320px;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            background: #fbfcfe;
        }

        .chat-list-header {
            padding: 12px 14px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-view-tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 3px;
        }

        .chat-view-tab {
            flex: 1;
            text-align: center;
            padding: 6px 10px;
            font-size: 0.78rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.15s;
            color: #64748b;
            border: none;
            background: transparent;
        }

        .chat-view-tab.active {
            background: white;
            color: var(--blue);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chat-list-search input {
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            font-size: 0.84rem;
            width: 100%;
            background: white;
        }

        .chat-sort-bar {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-sort-bar select {
            font-size: 0.76rem;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            color: #475569;
            flex: 1;
        }

        .chat-list-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }

        .chat-list-item:hover {
            background: #f0f5ff;
        }

        .chat-list-item.active {
            background: #eef4ff;
            border-left: 4px solid var(--blue);
        }

        .chat-list-item.has-keyword-match {
            background: #fef2f2;
            border-left: 4px solid transparent;
        }

        .chat-list-item.has-keyword-match:hover {
            background: #fee2e2;
        }

        .chat-list-item.has-keyword-match.active {
            background: #fee2e2;
            border-left: 4px solid var(--blue);
        }

        .chat-list-item.has-keyword-match .name-text {
            color: #dc2626;
            font-weight: 700;
        }

        .keyword-flag {
            font-size: 0.75rem;
            color: #dc2626;
            margin-left: 4px;
            font-weight: 700;
        }

        .chat-list-item .chat-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--slate-900);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chat-list-item .chat-preview {
            font-size: 0.78rem;
            color: var(--gray);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item .chat-time {
            font-size: 0.7rem;
            color: #94a3b8;
            position: absolute;
            top: 12px;
            right: 14px;
        }

        .chat-list-item .chat-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dot-bot {
            background: #f59e0b;
        }

        .dot-agent {
            background: #10b981;
        }

        .dot-closed {
            background: #94a3b8;
        }

        .chat-list-item.has-keyword-match {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .chat-list-item.has-keyword-match:hover {
            background: #fee2e2;
        }

        .keyword-flag {
            font-size: 0.6rem;
            background: #fee2e2;
            color: #dc2626;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* --- Session tags in sidebar --- */
        .chat-item-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .chat-tag-pill {
            font-size: 0.62rem;
            padding: 1px 7px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .tag-impt {
            background: #fef2f2;
            color: #dc2626;
        }

        .tag-waiting {
            background: #fffbeb;
            color: #d97706;
        }

        .tag-completed {
            background: #ecfdf5;
            color: #059669;
        }

        .tag-follow-up {
            background: #eff6ff;
            color: #2563eb;
        }

        .pin-icon {
            font-size: 0.72rem;
            color: #f59e0b;
        }

        /* --- Context menu for chat items --- */
        .chat-item-menu {
            position: absolute;
            top: 8px;
            right: 36px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .chat-list-item:hover .chat-item-menu {
            opacity: 1;
        }

        .chat-item-menu-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.72rem;
            color: #64748b;
        }

        .chat-item-menu-btn:hover {
            background: #e2e8f0;
        }

        /* --- Dropdown context menu --- */
        .ctx-menu {
            position: fixed;
            z-index: 3000;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 6px 0;
            min-width: 180px;
        }

        .ctx-menu-item {
            padding: 8px 16px;
            font-size: 0.82rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.1s;
        }

        .ctx-menu-item:hover {
            background: #f1f5f9;
        }

        .ctx-menu-item.danger {
            color: #dc2626;
        }

        .ctx-menu-item.danger:hover {
            background: #fef2f2;
        }

        .ctx-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        /* --- Main Chat Panel --- */
        .chat-main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #eff6ff;
            /* Light blue background */
        }

        .chat-header-bar {
            padding: 12px 18px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: var(--blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .chat-header-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--slate-900);
        }

        .chat-header-status {
            font-size: 0.74rem;
            font-weight: 600;
        }

        .chat-header-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chat-messages-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .message-row {
            display: flex;
            gap: 10px;
            max-width: 85%;
        }

        .message-row.mine {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-row.other {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            flex-shrink: 0;
            overflow: hidden;
            background: #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #475569;
            border: 1px solid rgba(0,0,0,0.05);
            margin-top: 4px;
        }

        /* --- Chat bubbles --- */
        .chat-bubble {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.86rem;
            line-height: 1.5;
            position: relative;
            transition: 0.15s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .chat-bubble:hover .msg-delete-btn {
            opacity: 1;
        }

        .chat-bubble .bubble-time {
            font-size: 0.66rem;
            color: #94a3b8;
            margin-top: 4px;
            text-align: right;
        }

        .bubble-customer {
            background: #f1f5f9;
            color: #334155;
            border-top-left-radius: 4px;
        }

        .bubble-bot {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #78350f;
            border-top-left-radius: 4px;
            font-size: 0.82rem;
        }

        .bubble-agent {
            background: var(--blue);
            color: white;
            border-top-right-radius: 4px;
        }

        .bubble-agent.mine {
            background: var(--blue);
        }

        .bubble-agent .bubble-time {
            color: rgba(255, 255, 255, 0.65);
        }

        .bubble-system {
            background: #ecfdf5;
            border: 1px dashed #10b981;
            color: #065f46;
            align-self: center;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: 10px;
            max-width: 90%;
            padding: 10px 14px;
        }

        .bubble-keyword-match {
            box-shadow: 0 0 0 2px #ef4444, 0 0 12px rgba(239, 68, 55, 0.2);
        }

        .keyword-highlight {
            background: #fecaca;
            color: #991b1b;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        /* --- Message Actions --- */
        /* Message Actions */
        .msg-actions {
            position: absolute;
            top: -24px;
            right: 0;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .message-row.mine .msg-actions {
            right: 0;
            left: auto;
        }

        .message-row.other .msg-actions {
            left: 0;
            right: auto;
        }

        .chat-bubble:hover .msg-actions {
            opacity: 1;
        }

        .msg-action-btn {
            background: none;
            border: none;
            padding: 2px 4px;
            font-size: 0.8rem;
            color: #64748b;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .msg-action-btn:hover {
            color: var(--blue);
            transform: scale(1.1);
        }

        .msg-action-btn.delete:hover {
            color: #ef4444;
        }

        .edit-container textarea {
            width: 100%;
            min-width: 200px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 8px;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        /* --- Input Area --- */
        .chat-input-bar {
            padding: 12px 18px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
            background: #fafbfc;
        }

        .chat-input-bar input {
            flex: 1;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 9px 14px;
            font-size: 0.88rem;
        }

        .chat-input-bar input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* --- Empty state --- */
        .chat-empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--gray);
        }

        .chat-empty-state h3 {
            font-size: 1.08rem;
            color: var(--slate-900);
            margin-bottom: 6px;
        }

        /* --- Links panel --- */
        .chat-links-panel {
            padding: 10px 18px;
            border-top: 1px solid #e2e8f0;
            background: #f9fafb;
            font-size: 0.8rem;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .chat-link-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #eef4ff;
            color: var(--blue);
            padding: 3px 9px;
            border-radius: 8px;
            font-size: 0.76rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
        }

        .chat-link-badge:hover {
            background: #dbeafe;
        }

        .chat-link-badge.unlinked {
            background: #f1f5f9;
            color: var(--gray);
            border: 1px dashed #cbd5e1;
        }

        /* --- Tags bar in header --- */
        .chat-tags-bar {
            padding: 8px 18px;
            border-bottom: 1px solid #e2e8f0;
            background: #fafbfc;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tag-toggle-btn {
            font-size: 0.72rem;
            padding: 3px 10px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-weight: 600;
            transition: 0.15s;
            background: white;
            color: #64748b;
        }

        .tag-toggle-btn.active-tag-impt {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }

        .tag-toggle-btn.active-tag-waiting {
            background: #fffbeb;
            color: #d97706;
            border-color: #fde68a;
        }

        .tag-toggle-btn.active-tag-completed {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }

        .tag-toggle-btn.active-tag-follow-up {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .tag-toggle-btn:hover {
            border-color: #94a3b8;
        }

        /* --- Takeover overlay --- */
        .takeover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .takeover-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .takeover-card h3 {
            margin: 0 0 10px;
            font-size: 1.12rem;
        }

        .takeover-card p {
            color: var(--gray);
            font-size: 0.86rem;
            margin-bottom: 18px;
        }

        .takeover-card .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }




    </style>
</head>

<script>
    // Global User Context for Standardized Modals
    window.currUserId = {{ (session.get('user_id', 0) or 0) | tojson }};
    window.currUserRole = {{ (session.get('user_role', 'agent')) | tojson }};
    window.currUsername = {{ (session.get('user_username', '')) | tojson }};

    window.backendSearchSeed = {{ search_seed | tojson if search_seed is not undefined else '[]' }};
    window.ruleKeywords = {{ rule_keywords | tojson if rule_keywords is not undefined else '[]' }};
</script>

<body id="page-history" class="{% if current_theme and current_theme != 'light' %}theme-{{ current_theme }}{% endif %}">
    <aside class="sidebar">
        <h2>CRM Admin</h2>
        <a href="/dashboard" class="nav-link nav-dashboard">Dashboard</a>
        <a href="/customers" class="nav-link nav-customers">Customer List</a>
        <a href="/my-team" class="nav-link nav-my-team d-flex justify-content-between align-items-center">
            My Team
            <div class="d-flex align-items-center gap-1">
                {% if unread_team_messages %}
                <span class="rounded-circle bg-warning" style="width: 10px; height: 10px; display: inline-block;"></span>
                {% endif %}
                {% if team_pending_requests_count and team_pending_requests_count > 0 %}
                <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.9em;"></i>
                {% endif %}
            </div>
        </a>
        <a href="/templates-manager" class="nav-link nav-templates">Template Manager</a>
        <a href="/history" class="nav-link nav-history active d-flex justify-content-between align-items-center">
            Chat History
            {% if transfer_request_count and transfer_request_count > 0 %}
            <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.9em;"></i>
            {% endif %}
        </a>
        <a href="/repository" class="nav-link nav-repository">Inquiry Repository</a>
        <a href="/scoring" class="nav-link nav-scoring">Lead Scoring</a>
        {% if session.get('user_role') in ['ultra_admin', 'super_admin', 'admin'] %}
        <a href="/admin/create-account" class="nav-link nav-admin">
            Manage Accounts
            {% if pending_promotion_count and pending_promotion_count > 0 %}
            <span class="badge bg-danger ms-2" style="font-size: 0.7em;">!</span>
            {% endif %}
        </a>
        {% endif %}
        <div class="mt-auto pt-3 border-top border-secondary" style="border-color: rgba(255,255,255,0.1) !important;">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar-circle bg-primary text-white me-2"
                        style="width: 32px; height: 32px; font-size: 14px; display:flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden;">
                        {% if session.get('user_pic') and 'http' in session.get('user_pic') %}
                        <img src="{{ session.get('user_pic') }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% elif session.get('user_pic') %}
                        <img src="{{ url_for('static', filename='uploads/' + session.get('user_pic')) }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% else %}
                        {{ session.get('user_name', 'Admin')[0] | upper }}
                        {% endif %}
                    </div>
                    <strong>{{ session.get('user_name', 'Admin') }}</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="/profile">Edit Profile</a></li>
                    <li><a class="dropdown-item" href="/settings">Settings</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="/logout">Sign out</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">Conversations</h1>
            <div class="search-container">
                <input type="text" placeholder="Search leads, rules, or customers..."
                    class="taskbar-search form-control">
            </div>
        </div>

        <div class="chat-page-container">

            <!-- === LEFT: CHAT LIST === -->
            <div class="chat-list-panel">
                <div class="chat-list-header">
                    <!-- Active / Archived toggle -->
                    <div class="chat-view-tabs">
                        <button class="chat-view-tab {% if current_view == 'active' %}active{% endif %}"
                            onclick="switchView('active')">Ongoing</button>
                        <button class="chat-view-tab {% if current_view == 'archived' %}active{% endif %}"
                            onclick="switchView('archived')">Archived</button>
                    </div>

                    <!-- Search -->
                    <div class="chat-list-search">
                        <input type="text" id="chatSearchInput" placeholder="Search visitors or content..."
                            oninput="filterChatList()">
                    </div>

                    <!-- Sort -->
                    <div class="chat-sort-bar">
                        <select id="chatSortSelect" onchange="sortChatList()">
                            <option value="default">Default Sort</option>
                            <option value="newest">Recent First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name-az">Name (A-Z)</option>
                            <option value="name-za">Name (Z-A)</option>
                            <option value="score-high">High Lead Score</option>
                            <option value="score-low">Low Lead Score</option>
                        </select>
                    </div>
                </div>

                <div class="chat-list-scroll" id="chatListScroll">
                    {% for s in sessions %}
                    <div class="chat-list-item {% if loop.first %}active{% endif %} {% if s.is_lead %}has-keyword-match{% endif %}"
                        data-session-id="{{ s.id }}" data-name="{{ s.visitor_name }}"
                        data-pinned="{{ s.pinned | lower }}" data-tags="{{ s.tags or '' }}"
                        data-status="{{ s.status }}" onclick="selectChat({{ s.id }})"
                        data-score="{{ s.calculated_score | int }}"
                        data-transfer-status="{{ s.transfer_status }}"
                        data-assigned-agent-id="{{ s.assigned_agent_id or '' }}">

                        <div class="chat-time">
                            {% if s.chat_messages %}{{ s.chat_messages[-1].timestamp }}{% endif %}
                        </div>

                        <!-- Context menu button -->
                        <div class="chat-item-menu">
                            <button class="chat-item-menu-btn"
                                onclick="event.stopPropagation(); openChatContextMenu(event, {{ s.id }})">‚ãØ</button>
                        </div>

                        <div class="chat-name">
                            <span
                                class="chat-status-dot {% if s.status == 'bot' %}dot-bot{% elif s.status == 'agent_active' %}dot-agent{% else %}dot-closed{% endif %}"></span>
                            {% if s.pinned %}<span class="pin-icon">üìå</span>{% endif %}
                            <span class="name-text" onclick="event.stopPropagation(); showVisitorProfile({{ s.id }})"
                                style="cursor:pointer; text-decoration:underline;">{{ s.visitor_name }}</span>
                            {% if s.transfer_status == 'pending' and s.assigned_agent_id|int == session.get('user_id')|int %}
                            <i class="bi bi-exclamation-circle-fill text-danger ms-1" title="Transfer Request Incoming"></i>
                            {% endif %}
                            {% if s.is_lead %}
                            <span class="keyword-flag"> ‚ö° Lead ({{ s.calculated_score | int }})</span>
                            {% endif %}
                        </div>

                        <div class="chat-preview">
                            {% if s.chat_messages %}{{ s.chat_messages[-1].text[:55] }}{% if
                            s.chat_messages[-1].text|length > 55 %}...{% endif %}{% endif %}
                        </div>

                        {% if s.tags %}
                        <div class="chat-item-tags">
                            {% for tag in s.tags.split(',') %}
                            {% if tag.strip() %}
                            <span class="chat-tag-pill tag-{{ tag.strip() }}">{{ tag.strip() }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- === RIGHT: CHAT MAIN === -->
            <div class="chat-main-panel" id="chatMainPanel">
                {% if sessions|length > 0 %}
                <!-- Header -->
                <div class="chat-header-bar" id="chatHeaderBar">
                    <div class="chat-header-info">
                        <div class="chat-header-avatar" id="chatAvatar"></div>
                        <div id="agentAvatarContainer"
                            style="display:none; margin-left:-18px; position:relative; z-index:2; cursor:pointer;"
                            onclick="if(currentAssignedAgentId) showAgentProfile(currentAssignedAgentId)"
                            title="View profile">
                            <img id="agentAvatarImg" src=""
                                style="width:40px; height:40px; border-radius:12px; border:2px solid white; object-fit:cover;">
                            <div id="agentAvatarInitials"
                                style="width:40px; height:40px; border-radius:12px; border:2px solid white; background:var(--blue); color:white; display:none; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem;">
                            </div>
                        </div>
                        <div>
                            <div class="chat-header-name">
                                <a id="chatHeaderName" href="#" style="color:inherit; text-decoration:none;"></a>
                            </div>
                            <div class="chat-header-status" id="chatHeaderStatus"></div>
                        </div>
                    </div>
                    <div class="chat-header-actions" id="chatHeaderActions">
                        <button class="btn btn-sm btn-gray" onclick="openLinkCustomerModal()" id="btnLinkCustomer">üë§
                            Link</button>
                        <button class="btn btn-sm btn-gray" onclick="openLinkInquiryModal()" id="btnLinkInquiry">üìã
                            Link</button>
                        <div id="transferActions" style="display:inline-flex; gap:8px;">
                            <button class="btn btn-sm btn-blue" onclick="confirmTakeOver()" id="btnTakeOver">üéß Take
                                Over</button>
                        </div>
                    </div>
                </div>

                <!-- Tags bar -->
                <div class="chat-tags-bar" id="chatTagsBar">
                    <span style="font-size:0.76rem; color:#64748b; font-weight:600;">Tags:</span>
                    <button class="tag-toggle-btn" data-tag="impt" onclick="toggleTag('impt')">üî¥ Important</button>
                    <button class="tag-toggle-btn" data-tag="waiting" onclick="toggleTag('waiting')">üü° Waiting</button>
                    <button class="tag-toggle-btn" data-tag="completed" onclick="toggleTag('completed')">üü¢
                        Completed</button>
                    <button class="tag-toggle-btn" data-tag="follow-up" onclick="toggleTag('follow-up')">üîµ
                        Follow-up</button>
                </div>

                <!-- Links bar -->
                <div class="chat-links-panel" id="chatLinksPanel">
                    <span id="linkedCustomerBadge" class="chat-link-badge unlinked" onclick="openLinkCustomerModal()">üë§
                        No customer linked</span>
                    <span id="linkedInquiryBadge" class="chat-link-badge unlinked" onclick="openLinkInquiryModal()">üìã
                        No inquiry linked</span>
                </div>

                <!-- Messages -->
                <div class="chat-messages-scroll" id="chatMessagesScroll"></div>

                <!-- Input -->
                <div class="chat-input-bar">
                    <input type="text" id="chatMsgInput" placeholder="Take over chat to start typing..." disabled
                        onkeydown="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-blue px-4" id="btnSend" onclick="sendChatMessage()" disabled>Send</button>
                </div>
                {% else %}
                <div class="chat-empty-state">
                    <div>
                        <h3>{% if current_view == 'archived' %}No archived conversations{% else %}No conversations yet{%
                            endif %}</h3>
                        <p>{% if current_view == 'archived' %}Archived chats will appear here.{% else %}Chats will
                            appear here when customers start messaging.{% endif %}</p>
                        {% if current_view == 'archived' %}
                        <a href="/history?view=active" class="btn btn-sm btn-blue">‚Üê Back to Active</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- LINK CUSTOMER MODAL -->
    <div class="modal fade" id="linkCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üë§ Link Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="linkCustomerTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabPromoteCust"
                                type="button">‚ú® Promote</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLinkExistingCust"
                                type="button">Existing</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCreateNewCust"
                                type="button">Create New</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- PROMOTE -->
                        <div class="tab-pane fade show active" id="tabPromoteCust">
                            <div class="text-center py-4 px-2">
                                <div class="mb-4">
                                    <div class="fs-1 mb-2">‚ú®</div>
                                    <h6 class="fw-bold">Promote to Customer</h6>
                                    <p class="small text-muted">Instantly convert this visitor into a permanent CRM customer using their chat details.</p>
                                </div>
                                <div class="p-3 border rounded-4 bg-light text-start mb-4">
                                    <div class="small mb-1"><span class="text-muted">Name:</span> <strong id="promoteName">...</strong></div>
                                    <div class="small mb-1"><span class="text-muted">Email:</span> <strong id="promoteEmail">...</strong></div>
                                    <div class="small"><span class="text-muted">Phone:</span> <strong id="promotePhone">...</strong></div>
                                </div>
                                <button id="modalPromoteBtn" class="btn btn-blue w-100 py-3 rounded-4 fw-bold shadow-sm" onclick="promoteCurrentVisitor()">
                                    Promote Now
                                </button>
                            </div>
                        </div>

                        <!-- LINK EXISTING -->
                        <div class="tab-pane fade" id="tabLinkExistingCust">
                            <p class="small text-muted">Select a customer to link to this conversation.</p>
                            <select class="form-select" id="linkCustomerSelect">
                                <option value="">-- None --</option>
                                {% for c in customers %}
                                <option value="{{ c.id }}">{{ c.name }} ({{ c.email }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- CREATE NEW -->
                        <div class="tab-pane fade" id="tabCreateNewCust">
                            <div class="mb-2">
                                <label class="small text-muted">First Name</label>
                                <input type="text" class="form-control form-control-sm" id="newCustFirst">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">Last Name</label>
                                <input type="text" class="form-control form-control-sm" id="newCustLast">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">Email</label>
                                <input type="email" class="form-control form-control-sm" id="newCustEmail">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">Phone</label>
                                <input type="text" class="form-control form-control-sm" id="newCustPhone">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-blue" onclick="handleLinkCustomer()">Link / Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LINK INQUIRY MODAL -->
    <div class="modal fade" id="linkInquiryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìã Link Inquiry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="linkInquiryTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabLinkExistingInq"
                                type="button">Existing</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCreateNewInq"
                                type="button">Create New</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- LINK EXISTING -->
                        <div class="tab-pane fade show active" id="tabLinkExistingInq">
                            <p class="small text-muted">Select an inquiry to attach to this conversation.</p>
                            <select class="form-select" id="linkInquirySelect">
                                <option value="">-- None --</option>
                                {% for i in inquiries %}
                                <option value="{{ i.id }}">INQ-{{ "%03d"|format(i.id) }}: {{ i.customer }} ({{ i.status
                                    }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- CREATE NEW -->
                        <div class="tab-pane fade" id="tabCreateNewInq">
                            <div class="mb-2">
                                <label class="small text-muted">Customer Name</label>
                                <input type="text" class="form-control form-control-sm" id="newInqCustomer">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">Type</label>
                                <select class="form-select form-select-sm" id="newInqType">
                                    <option value="General">General</option>
                                    <option value="Support">Support</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Billing">Billing</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted">Description</label>
                                <textarea class="form-control form-control-sm" id="newInqDesc" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-blue" onclick="handleLinkInquiry()">Link / Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAKEOVER / CONFIRM OVERLAYS (injected via JS) -->
    <div id="takeoverOverlay" style="display:none;"></div>
    <div id="confirmOverlay" style="display:none;"></div>

    <!-- CONTEXT MENU (injected via JS) -->
    <div id="ctxMenu" class="ctx-menu" style="display:none;"></div>

    <script>
        // ===== STATE =====
        let currentSessionId = null;
        let currentSessionStatus = null;
        let currentAssignedAgentId = null;
        let currentLinkedCustomerId = null;
        let currentVisitorEmail = null; // Added
        let currentVisitorPhone = null; // Added
        let currentSessionTags = [];
        const keywords = window.ruleKeywords || [];
        const currentView = '{{ current_view }}';
        let currentUserId = {{ session.get('user_id') or 'null' }};
        let lastMessageId = 0;
        let pollInterval = null;

        // ===== HANDLE TRANSFER =====
        async function handleTransfer(sessionId, action) {
            const res = await fetch(`/api/chat/session/${sessionId}/handle-transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            });
            const data = await res.json();
            if (data.ok) {
                location.reload();
            } else {
                alert(data.error || 'Failed to handle transfer');
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            const savedSessionId = localStorage.getItem('lastChatSessionId');

            if (sessionId) {
                selectChat(parseInt(sessionId));
                setTimeout(() => {
                    const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
                    if (item) item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            } else if (savedSessionId) {
                // Try to load the last viewed chat if it exists in the current view
                const item = document.querySelector(`.chat-list-item[data-session-id="${savedSessionId}"]`);
                if (item) {
                    selectChat(parseInt(savedSessionId));
                } else {
                    // Fallback to first item if saved session not in current view
                    const firstItem = document.querySelector('.chat-list-item');
                    if (firstItem) selectChat(parseInt(firstItem.dataset.sessionId));
                }
            } else {
                const firstItem = document.querySelector('.chat-list-item');
                if (firstItem) {
                    selectChat(parseInt(firstItem.dataset.sessionId));
                }
            }
            markKeywordChats();
            setInterval(pollSessionsList, 10000); // Sidebar polling every 10s

            // Load sort preference
            const savedSort = localStorage.getItem('chatSortPreference');
            if (savedSort) {
                const sortSelect = document.getElementById('chatSortSelect');
                if (sortSelect) {
                    sortSelect.value = savedSort;
                    sortChatList();
                }
            }
        });

        // Close context menu on click outside
        document.addEventListener('click', () => {
            document.getElementById('ctxMenu').style.display = 'none';
        });

        // ===== VIEW SWITCHING =====
        function switchView(view) {
            window.location.href = `/history?view=${view}`;
        }

        // ===== SORT CHAT LIST =====
        function sortChatList() {
            const sort = document.getElementById('chatSortSelect').value;
            localStorage.setItem('chatSortPreference', sort); // Save preference

            const container = document.getElementById('chatListScroll');
            const items = Array.from(container.querySelectorAll('.chat-list-item'));

            items.sort((a, b) => {
                if (sort === 'default') {
                    // Pinned first, then by ID desc
                    const aPinned = a.dataset.pinned === 'true' ? 1 : 0;
                    const bPinned = b.dataset.pinned === 'true' ? 1 : 0;
                    if (bPinned !== aPinned) return bPinned - aPinned;
                    return parseInt(b.dataset.sessionId) - parseInt(a.dataset.sessionId);
                }
                if (sort === 'newest') return parseInt(b.dataset.sessionId) - parseInt(a.dataset.sessionId);
                if (sort === 'oldest') return parseInt(a.dataset.sessionId) - parseInt(b.dataset.sessionId);
                if (sort === 'name-az') return a.dataset.name.localeCompare(b.dataset.name);
                if (sort === 'name-za') return b.dataset.name.localeCompare(a.dataset.name);
                if (sort === 'score-high') return parseInt(b.dataset.score || 0) - parseInt(a.dataset.score || 0);
                if (sort === 'score-low') return parseInt(a.dataset.score || 0) - parseInt(b.dataset.score || 0);
                return 0;
            });

            items.forEach(item => container.appendChild(item));
        }

        // ===== MARK SIDEBAR ITEMS WITH KEYWORD MATCHES =====
        function markKeywordChats() {
            document.querySelectorAll('.chat-list-item').forEach(item => {
                const preview = (item.querySelector('.chat-preview')?.textContent || '').toLowerCase();
                for (const kw of keywords) {
                    if (preview.includes(kw)) {
                        item.classList.add('has-keyword-match');
                        if (!item.querySelector('.keyword-flag')) {
                            const flag = document.createElement('span');
                            flag.className = 'keyword-flag';
                            flag.textContent = '‚ö° Lead';
                            item.querySelector('.chat-name').appendChild(flag);
                        }
                        break;
                    }
                }
            });
        }

        // ===== CONTEXT MENU FOR CHAT ITEMS =====
        function openChatContextMenu(e, sessionId) {
            e.preventDefault();
            e.stopPropagation();

            const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            const isPinned = item?.dataset.pinned === 'true';
            const isArchived = currentView === 'archived';
            const transferStatus = item?.dataset.transferStatus;
            const assignedAgentId = item?.dataset.assignedAgentId;

            const menu = document.getElementById('ctxMenu');
            let menuHtml = `
                <div class="ctx-menu-item" onclick="showVisitorProfile(${sessionId})">
                    <span class="me-2">üë§</span> View Full Profile
                </div>
                <div class="ctx-menu-divider"></div>
            `;

            if (transferStatus === 'pending' && parseInt(assignedAgentId) === currentUserId) {
                menuHtml += `
                    <div class="ctx-menu-item text-success fw-bold" onclick="handleTransfer(${sessionId}, 'accept')">
                        <span class="me-2">‚úÖ</span> Accept Transfer
                    </div>
                    <div class="ctx-menu-item text-danger fw-bold" onclick="handleTransfer(${sessionId}, 'reject')">
                        <span class="me-2">‚ùå</span> Reject Transfer
                    </div>
                    <div class="ctx-menu-divider"></div>
                `;
            }

            menuHtml += `
                <div class="ctx-menu-item" onclick="pinChat(${sessionId}, ${!isPinned})">
                    ${isPinned ? 'üìå Unpin' : 'üìå Pin to Top'}
                </div>
                <div class="ctx-menu-divider"></div>
                ${isArchived
                    ? `<div class="ctx-menu-item" onclick="archiveChat(${sessionId}, false)">üì§ Unarchive</div>`
                    : `<div class="ctx-menu-item" onclick="archiveChat(${sessionId}, true)">üì¶ Archive</div>`}
                <div class="ctx-menu-divider"></div>
                <div class="ctx-menu-item danger" onclick="confirmDeleteChat(${sessionId})">üóëÔ∏è Delete Chat</div>
            `;

            menu.innerHTML = menuHtml;
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';

            // Keep inside viewport
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 8) + 'px';
            if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 8) + 'px';
        }

        // ===== PIN/UNPIN =====
        async function pinChat(sessionId, pinned) {
            await fetch(`/api/chat/session/${sessionId}/pin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pinned })
            });
            location.reload();
        }

        // ===== ARCHIVE/UNARCHIVE =====
        async function archiveChat(sessionId, archived) {
            await fetch(`/api/chat/session/${sessionId}/archive`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ archived })
            });
            location.reload();
        }

        // ===== DELETE CHAT =====
        function confirmDeleteChat(sessionId) {
            askConfirmation(
                "Delete Chat?",
                "This will permanently delete this conversation and all its messages. This action cannot be undone.",
                "üóëÔ∏è",
                () => deleteChat(sessionId),
                'btn-danger'
            );
        }

        async function deleteChat(sessionId) {
            await fetch(`/api/chat/session/${sessionId}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            location.reload();
        }

        // ===== SELECT CHAT =====
        async function selectChat(sessionId) {
            currentSessionId = sessionId;
            localStorage.setItem('lastChatSessionId', sessionId);

            // Update sidebar active state
            document.querySelectorAll('.chat-list-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            if (activeItem) activeItem.classList.add('active');

            // Clear existing polling
            if (pollInterval) clearInterval(pollInterval);
            lastMessageId = 0;

            // Fetch messages (Initial Load)
            const res = await fetch(`/api/chat/session/${sessionId}/messages`);
            const data = await res.json();
            currentSessionStatus = data.session.status;
            currentAssignedAgentId = data.session.assigned_agent_id;
            currentLinkedCustomerId = data.session.linked_customer_id;
            currentVisitorEmail = data.session.visitor_email;
            currentVisitorPhone = data.session.visitor_phone;

            // Parse tags
            currentSessionTags = (data.session.tags || '').split(',').filter(t => t.trim());
            updateTagButtons();

            // Set up polling (exactly like team chat)
            pollInterval = setInterval(pollNewMessages, 3000);

            // Update header
            const name = data.session.visitor_name;
            const parts = name.trim().split(' ');
            const initials = parts[0][0] + (parts.length > 1 ? parts[parts.length - 1][0] : '');
            document.getElementById('chatAvatar').textContent = initials.toUpperCase();
            const headerNameLink = document.getElementById('chatHeaderName');
            headerNameLink.textContent = name;
            headerNameLink.onclick = (e) => {
                e.preventDefault();
                if (data.session.linked_customer_id) {
                    window.location.href = '/customer/' + data.session.linked_customer_id;
                } else {
                    openLinkCustomerModal();
                }
            };
            document.getElementById('chatAvatar').onclick = headerNameLink.onclick;
            document.getElementById('chatAvatar').style.cursor = 'pointer';
            headerNameLink.style.textDecoration = 'none';

            // Agent Avatar Update
            const agentAvatarContainer = document.getElementById('agentAvatarContainer');
            const agentAvatarImg = document.getElementById('agentAvatarImg');
            const agentAvatarInitials = document.getElementById('agentAvatarInitials');

            if (data.session.assigned_agent_id) {
                agentAvatarContainer.style.display = 'block';
                if (data.session.assigned_agent_pic) {
                    let picUrl = data.session.assigned_agent_pic;
                    if (!picUrl.startsWith('http')) {
                        picUrl = `/static/uploads/${picUrl}`;
                    }
                    agentAvatarImg.src = picUrl;
                    agentAvatarImg.style.display = 'block';
                    agentAvatarInitials.style.display = 'none';
                } else {
                    const agentParts = data.session.assigned_agent_name.trim().split(' ');
                    const agentInitials = agentParts[0][0] + (agentParts.length > 1 ? agentParts[agentParts.length - 1][0] : '');
                    agentAvatarInitials.textContent = agentInitials.toUpperCase();
                    agentAvatarInitials.style.display = 'flex';
                    agentAvatarImg.style.display = 'none';
                }
            } else {
                agentAvatarContainer.style.display = 'none';
            }

            // Ownership & Transfer Logic
            const actionsDiv = document.getElementById('transferActions');
            const statusEl = document.getElementById('chatHeaderStatus');
            const msgInput = document.getElementById('chatMsgInput');
            const btnSend = document.getElementById('btnSend');
            const currentUserId = data.session.current_user_id;
            const assignedId = data.session.assigned_agent_id;
            const isOwner = assignedId === currentUserId;

            // 1. Status Display
            if (data.session.status === 'bot') {
                statusEl.innerHTML = '<span style="color:#f59e0b;">ü§ñ Chatbot Active</span>';
            } else if (assignedId) {
                statusEl.innerHTML = `<span style="color:#10b981;">üü¢ Agent Active: ${data.session.assigned_agent_name}</span>`;
            } else {
                statusEl.innerHTML = '<span style="color:#94a3b8;">‚ö™ Closed</span>';
            }

            const isSuperAdmin = ['super_admin', 'ultra_admin'].includes('{{ user_role }}');

            // 2. Action Buttons & Input State
            actionsDiv.innerHTML = '';

            // Shared Super Admin Force Transfer Button
            const adminTransferBtnHTML = isSuperAdmin ? '<button class="btn btn-sm btn-outline-dark" onclick="openAdminTransferModal()">üõ°Ô∏è Admin Transfer</button>' : '';

            if (!assignedId) {
                // Unassigned
                actionsDiv.innerHTML = `
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-blue" onclick="confirmTakeOver()">üéß Take Over</button>
                        ${adminTransferBtnHTML}
                    </div>
                `;
                msgInput.disabled = true;
                msgInput.placeholder = 'Take over chat to start typing...';
                btnSend.disabled = true;
            } else if (isOwner) {
                // Current user is owner
                if (data.session.transfer_status === 'pending') {
                    actionsDiv.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">Transfer requested by ${data.session.requested_agent_name}</small>
                            <button class="btn btn-sm btn-outline-success" onclick="handleTransfer('accept')">Accept</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="handleTransfer('reject')">Reject</button>
                            ${adminTransferBtnHTML}
                        </div>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-success-subtle text-success">You own this chat</span>
                            ${adminTransferBtnHTML}
                        </div>
                    `;
                }
                msgInput.disabled = false;
                msgInput.placeholder = 'Type your message...';
                btnSend.disabled = false;
            } else {
                // Assigned to someone else
                if (data.session.transfer_status === 'pending' && data.session.requested_agent_id === currentUserId) {
                    actionsDiv.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-warning-subtle text-warning">Transfer Request Sent</span>
                            ${adminTransferBtnHTML}
                        </div>
                    `;
                } else {
                    if (isSuperAdmin) {
                        // Super admin gets options
                        actionsDiv.innerHTML = `
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="requestTransfer()">üîÑ Request Transfer</button>
                                <button class="btn btn-sm btn-danger" onclick="forceTakeOver()">‚ö° Force Take Over</button>
                                ${adminTransferBtnHTML}
                            </div>
                        `;
                    } else {
                        // Regular agent can only request
                        actionsDiv.innerHTML = '<button class="btn btn-sm btn-outline-primary" onclick="requestTransfer()">üîÑ Request Transfer</button>';
                    }
                }
                msgInput.disabled = true;
                msgInput.placeholder = `Only ${data.session.assigned_agent_name} can respond...`;
                btnSend.disabled = true;
            }

            // Update linked badges
            updateLinkedBadges(data.session);

            // Render messages
            renderMessages(data.messages);

            // Check keyword matches for sidebar highlighting
            checkKeywordMatchForSession(sessionId, data.messages);
        }

        // ===== TAG MANAGEMENT =====
        function updateTagButtons() {
            document.querySelectorAll('.tag-toggle-btn').forEach(btn => {
                const tag = btn.dataset.tag;
                btn.className = 'tag-toggle-btn';
                if (currentSessionTags.includes(tag)) {
                    btn.classList.add('active-tag-' + tag);
                }
            });
        }

        async function toggleTag(tag) {
            if (!currentSessionId) return;

            const idx = currentSessionTags.indexOf(tag);
            if (idx >= 0) {
                currentSessionTags.splice(idx, 1);
            } else {
                currentSessionTags.push(tag);
            }

            updateTagButtons();

            const tagsStr = currentSessionTags.join(',');
            await fetch(`/api/chat/session/${currentSessionId}/tags`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: tagsStr })
            });

            // Update sidebar item tags
            const sidebarItem = document.querySelector(`.chat-list-item[data-session-id="${currentSessionId}"]`);
            if (sidebarItem) {
                sidebarItem.dataset.tags = tagsStr;
                let tagsDiv = sidebarItem.querySelector('.chat-item-tags');
                if (!tagsDiv) {
                    tagsDiv = document.createElement('div');
                    tagsDiv.className = 'chat-item-tags';
                    sidebarItem.appendChild(tagsDiv);
                }
                tagsDiv.innerHTML = currentSessionTags
                    .map(t => `<span class="chat-tag-pill tag-${t}">${t}</span>`)
                    .join('');
            }
        }

        // ===== RENDER MESSAGES =====
        function renderMessages(messages, append = false) {
            const container = document.getElementById('chatMessagesScroll');
            if (!append) {
                container.innerHTML = '';
            }
            
            if (messages && messages.length > 0) {
                messages.forEach(msg => {
                    container.appendChild(createMessageRow(msg));
                    if (msg.id > lastMessageId) {
                        lastMessageId = msg.id;
                    }
                });
                container.scrollTop = container.scrollHeight;
            }
        }

        async function pollSessionsList() {
            try {
                const res = await fetch('/api/chat/sessions');
                if (!res.ok) return;
                const data = await res.json();
                
                const container = document.querySelector('.chat-list-scroll');
                if (!container) return;

                // For simplicity, we only update previews and highlights for existing items
                // To support NEW sessions appearing live, we'd need to re-render the list
                // Let's do a partial sync: update existing, add missing
                data.forEach(s => {
                    let item = container.querySelector(`.chat-list-item[data-session-id="${s.id}"]`);
                    if (item) {
                        // Synchronize data attributes for context menu logic
                        item.dataset.status = s.status;
                        item.dataset.pinned = String(s.pinned).toLowerCase();
                        item.dataset.archived = String(s.archived).toLowerCase();
                        item.dataset.transferStatus = s.transfer_status || '';
                        item.dataset.assignedAgentId = s.assigned_agent_id || '';

                        // Update status dot
                        const dot = item.querySelector('.chat-status-dot');
                        if (dot) {
                            dot.className = `chat-status-dot ${s.status === 'bot' ? 'dot-bot' : (s.status === 'agent_active' ? 'dot-agent' : 'dot-closed')}`;
                        }
                        
                        // Update preview (if not currently focused session, to avoid race conditions handled by pollNewMessages)
                        if (s.id !== currentSessionId) {
                            const preview = item.querySelector('.chat-preview');
                            if (preview) preview.textContent = s.last_message;
                        }

                        // Update score flag if lead
                        const nameDiv = item.querySelector('.chat-name');
                        const flag = nameDiv.querySelector('.keyword-flag');
                        if (s.is_lead && !flag) {
                             const span = document.createElement('span');
                             span.className = 'keyword-flag';
                             span.textContent = ` ‚ö° Lead (${Math.floor(s.calculated_score || 0)})`;
                             nameDiv.appendChild(span);
                        }
                    } else {
                        // NEW session arrived!
                        // For now, let's just reload the counts or suggest a refresh if it's too complex to re-render
                        // Actually, let's just reload the page if a NEW session is detected to keep it simple and robust
                        // location.reload(); 
                        // Actually reload is too aggressive. Let's just ignore for now or add a simple "new chat" toast.
                    }
                });
            } catch (err) {
                console.error("List polling error:", err);
            }
        }

        async function pollNewMessages() {
            if (!currentSessionId) return;
            try {
                const res = await fetch(`/api/chat/session/${currentSessionId}/messages?since=${lastMessageId}`);
                if (!res.ok) return;
                const data = await res.json();
                
                // Update Session Metadata (in case status/assignment/tags changed)
                if (data.session) {
                    currentSessionStatus = data.session.status;
                    currentAssignedAgentId = data.session.assigned_agent_id;
                    currentLinkedCustomerId = data.session.linked_customer_id;
                    currentSessionTags = (data.session.tags || '').split(',').filter(t => t.trim());
                    
                    // Update UI elements that might have changed
                    updateTagButtons();
                    updateLinkedBadges(data.session);
                    
                    // Update header status & actions if needed
                    const statusEl = document.getElementById('chatHeaderStatus');
                    const assignedId = data.session.assigned_agent_id;
                    if (data.session.status === 'bot') {
                        statusEl.innerHTML = '<span style="color:#f59e0b;">ü§ñ Chatbot Active</span>';
                    } else if (assignedId) {
                        statusEl.innerHTML = `<span style="color:#10b981;">üü¢ Agent Active: ${data.session.assigned_agent_name}</span>`;
                    } else {
                        statusEl.innerHTML = '<span style="color:#94a3b8;">‚ö™ Closed</span>';
                    }

                    // We don't re-render all action buttons here to avoid disrupting user interaction,
                    // but we could if we wanted to be perfectly in sync. 
                    // For now, let's at least update the sidebar previews.
                }

                if (data.messages && data.messages.length > 0) {
                    renderMessages(data.messages, true);
                    
                    // Mark keywords for matches
                    checkKeywordMatchForSession(currentSessionId, data.messages);

                    // Also update sidebar preview for this session
                    const sidebarItem = document.querySelector(`.chat-list-item[data-session-id="${currentSessionId}"]`);
                    if (sidebarItem) {
                        const previewEl = sidebarItem.querySelector('.chat-preview');
                        if (previewEl) {
                            const lastMsg = data.messages[data.messages.length - 1];
                            previewEl.textContent = (lastMsg.sender_type === 'agent' ? 'You: ' : (lastMsg.sender_name + ': ')) + lastMsg.text;
                        }
                    }
                }
            } catch (err) {
                console.error("Polling error:", err);
            }
        }

        function createMessageRow(msg) {
            if (msg.sender_type === 'system') {
                const div = document.createElement('div');
                div.className = 'bubble-system';
                div.innerHTML = `<div>${escapeHtml(msg.text)}</div>`;
                return div;
            }

            const isResponder = msg.sender_type === 'agent' || msg.sender_type === 'bot';
            const row = document.createElement('div');
            row.className = `message-row ${isResponder ? 'mine' : 'other'}`;

            let bubbleClass = 'bubble-customer';
            if (msg.sender_type === 'bot') bubbleClass = 'bubble-bot';
            else if (msg.sender_type === 'agent') bubbleClass = 'bubble-agent';

            // Avatar Logic
            let avatarHtml = '';
            if (msg.sender_type === 'bot') {
                avatarHtml = '<span>ü§ñ</span>';
            } else if (msg.sender_type === 'agent') {
                const picUrl = msg.pic ? (msg.pic.includes('http') ? msg.pic : `/static/uploads/${msg.pic}`) : '';
                avatarHtml = picUrl 
                    ? `<img src="${picUrl}" style="width:100%; height:100%; object-fit:cover;">` 
                    : `<span>${msg.sender_name[0].toUpperCase()}</span>`;
            } else {
                // Customer
                avatarHtml = `<span>${msg.sender_name[0].toUpperCase()}</span>`;
            }

            // Keyword match logic
            let textHtml = escapeHtml(msg.text);
            let hasMatch = false;
            if (msg.sender_type === 'customer') {
                const lowerText = msg.text.toLowerCase();
                for (const kw of keywords) {
                    if (lowerText.includes(kw)) {
                        hasMatch = true;
                        const regex = new RegExp(`(${escapeRegex(kw)})`, 'gi');
                        textHtml = textHtml.replace(regex, '<span class="keyword-highlight">$1</span>');
                    }
                }
            }

            // Edit & Delete buttons container
            let actionBtns = '';
            if (msg.sender_type === 'agent' || msg.sender_type === 'bot') {
                actionBtns = `
                    <div class="msg-actions">
                        <button class="msg-action-btn edit" onclick="editMessage(${msg.id}, this)" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="msg-action-btn delete" onclick="deleteMessage(${msg.id}, this)" title="Delete"><i class="bi bi-trash"></i></button>
                    </div>
                `;
            } else if (msg.sender_type === 'customer') {
                actionBtns = `
                    <div class="msg-actions">
                        <button class="msg-action-btn delete" onclick="deleteMessage(${msg.id}, this)" title="Delete"><i class="bi bi-trash"></i></button>
                    </div>
                `;
            }

            row.innerHTML = `
                <div class="chat-avatar shadow-sm" title="${msg.sender_name}">
                    ${avatarHtml}
                </div>
                <div class="chat-bubble ${bubbleClass} ${hasMatch ? 'bubble-keyword-match' : ''}" data-msgId="${msg.id}">
                    ${actionBtns}
                    <div class="msg-sender"><small class="fw-bold opacity-75">${msg.sender_name}</small></div>
                    <div class="msg-content">${textHtml}</div>
                    <div class="bubble-time">${formatChatMessageTime(msg.timestamp || '')}</div>
                </div>
            `;
            return row;
        }

        // ===== DELETE MESSAGE =====
        async function deleteMessage(msgId, btnEl) {
            askConfirmation(
                "Delete Message?",
                "Are you sure you want to delete this message? This cannot be undone.",
                "üóëÔ∏è",
                async () => {
                    try {
                        const res = await fetch(`/api/chat/message/${msgId}/delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await res.json();

                        if (data.ok) {
                            const bubble = btnEl.closest('.chat-bubble');
                            bubble.style.transition = 'opacity 0.3s, transform 0.3s';
                            bubble.style.opacity = '0.5';
                            const textDiv = Array.from(bubble.children).find(el =>
                                el.tagName === 'DIV' &&
                                !el.classList.contains('bubble-time') &&
                                !el.classList.contains('edit-container') &&
                                !el.classList.contains('msg-actions')
                            );
                            if (textDiv) textDiv.innerHTML = '<i>Message deleted</i>';
                            const actions = bubble.querySelector('.msg-actions');
                            if (actions) actions.remove();
                            if (typeof showToast === 'function') showToast("Message deleted.", "blue");
                        } else {
                            if (typeof showToast === 'function') showToast(data.error || 'Cannot delete message.', "red");
                            else alert(data.error || 'Cannot delete this message.');
                        }
                    } catch (err) {
                        console.error(err);
                        if (typeof showToast === 'function') showToast('Error deleting message.', "red");
                        else alert('Error deleting message.');
                    }
                },
                'btn-danger'
            );
        }

        function askConfirmation(title, message, icon, action, btnClass = 'btn-primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').textContent = icon;
            const btn = document.getElementById('confirmActionBtn');
            btn.className = `btn flex-grow-1 ${btnClass}`;
            btn.onclick = () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                if (modal) modal.hide();
                action();
            };
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ===== CHECK KEYWORD MATCH FOR SIDEBAR =====
        function checkKeywordMatchForSession(sessionId, messages) {
            const item = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            if (!item) return;

            let found = false;
            for (const msg of messages) {
                if (msg.sender_type === 'customer') {
                    const lower = msg.text.toLowerCase();
                    for (const kw of keywords) {
                        if (lower.includes(kw)) { found = true; break; }
                    }
                }
                if (found) break;
            }

            if (found) {
                item.classList.add('has-keyword-match');
                if (!item.querySelector('.keyword-flag')) {
                    const flag = document.createElement('span');
                    flag.className = 'keyword-flag';
                    flag.textContent = ' ‚ö° Lead';
                    item.querySelector('.chat-name').appendChild(flag);
                }
            }
        }

        // ===== SEND MESSAGE =====
        async function sendChatMessage() {
            const input = document.getElementById('chatMsgInput');
            const text = input.value.trim();
            if (!text || !currentSessionId || currentSessionStatus !== 'agent_active') return;

            input.value = '';

            const res = await fetch(`/api/chat/session/${currentSessionId}/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            if (data.ok) {
                const container = document.getElementById('chatMessagesScroll');
                container.appendChild(createMessageRow(data.message));
                container.scrollTop = container.scrollHeight;
                if (data.message.id > lastMessageId) {
                    lastMessageId = data.message.id;
                }
            }
        }

        // ===== TAKE OVER CHAT =====
        function confirmTakeOver() {
            if (currentSessionStatus === 'agent_active') return;

            const overlay = document.getElementById('takeoverOverlay');
            overlay.style.display = 'flex';
            overlay.className = 'takeover-overlay';
            overlay.innerHTML = `
                <div class="takeover-card">
                    <h3>üéß Take Over Chat</h3>
                    <p>This will notify the customer that a human agent has joined the conversation. The chatbot will stop responding.</p>
                    <div class="btn-group">
                        <button class="btn btn-gray" onclick="cancelTakeOver()">Cancel</button>
                        <button class="btn btn-blue" onclick="executeTakeOver()">Confirm Take Over</button>
                    </div>
                </div>
            `;
        }

        function cancelTakeOver() {
            document.getElementById('takeoverOverlay').style.display = 'none';
        }

        async function executeTakeOver() {
            document.getElementById('takeoverOverlay').style.display = 'none';

            const res = await fetch(`/api/chat/session/${currentSessionId}/takeover`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();

            if (data.ok) {
                selectChat(currentSessionId); // Refresh UI
            } else {
            alert(data.error || 'Failed to take over.');
            }
        }

        function requestTransfer() {
            askConfirmation(
                "Request Transfer?",
                "Request to take over this chat from the current agent? They will be notified and can accept or reject your request.",
                "ü§ù",
                () => executeRequestTransfer(),
                'btn-blue'
            );
        }

        async function executeRequestTransfer() {
            const res = await fetch(`/api/chat/session/${currentSessionId}/request-transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (data.ok) {
                selectChat(currentSessionId);
            } else {
                alert(data.error);
            }
        }

        async function handleTransfer(action) {
            const res = await fetch(`/api/chat/session/${currentSessionId}/handle-transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            });
            const data = await res.json();
            if (data.ok) {
                selectChat(currentSessionId);
            } else {
                alert(data.error);
            }
        }

        function forceTakeOver() {
            askConfirmation(
                "Force Take Over?",
                "Warning: This will immediately transfer the chat to you without requiring approval from the current agent. Use this power responsibly.",
                "‚ö°",
                () => executeForceTakeOver(),
                'btn-danger'
            );
        }

        async function executeForceTakeOver() {

            const res = await fetch(`/api/chat/session/${currentSessionId}/force-takeover`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();

            if (data.ok) {
                selectChat(currentSessionId); // Refresh UI
            } else {
                alert(data.error || 'Failed to force take over.');
            }
        }

        function openAdminTransferModal() {
            if (!currentSessionId) return;
            new bootstrap.Modal(document.getElementById('adminTransferModal')).show();
        }

        async function executeAdminTransfer() {
            const targetUserId = document.getElementById('adminTransferAgentSelect').value;
            if (!targetUserId) {
                alert('Please select an agent.');
                return;
            }

            const res = await fetch(`/api/chat/session/${currentSessionId}/admin-transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target_user_id: targetUserId })
            });

            const data = await res.json();
            if (data.ok) {
                bootstrap.Modal.getInstance(document.getElementById('adminTransferModal')).hide();
                selectChat(currentSessionId);
            } else {
                alert(data.error || 'Error transferring chat.');
            }
        }

        // ===== LINK CUSTOMER =====
        function openLinkCustomerModal() {
            // Update Promote tab info
            const name = document.getElementById('chatHeaderName').textContent.trim();
            document.getElementById('promoteName').textContent = name;
            document.getElementById('promoteEmail').textContent = currentVisitorEmail || 'Not Provided';
            document.getElementById('promotePhone').textContent = currentVisitorPhone || 'Not Provided';

            // Disable Promote tab if already linked to a customer
            const promoteTabBtn = document.querySelector('button[data-bs-target="#tabPromoteCust"]');
            const existingTabBtn = document.querySelector('button[data-bs-target="#tabLinkExistingCust"]');
            
            if (currentLinkedCustomerId) {
                if (promoteTabBtn) {
                    promoteTabBtn.parentElement.style.display = 'none';
                }
                if (existingTabBtn) {
                    bootstrap.Tab.getOrCreateInstance(existingTabBtn).show();
                }
            } else {
                if (promoteTabBtn) {
                    promoteTabBtn.parentElement.style.display = 'block';
                    bootstrap.Tab.getOrCreateInstance(promoteTabBtn).show();
                }
            }

            const modal = new bootstrap.Modal(document.getElementById('linkCustomerModal'));
            modal.show();
        }

        async function promoteCurrentVisitor() {
            if (!currentSessionId) return;
            const btn = document.getElementById('modalPromoteBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Promoting...';

            try {
                const res = await fetch(`/api/chat/session/${currentSessionId}/become-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.ok) {
                    const modalEl = document.getElementById('linkCustomerModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    if (typeof showToast === 'function') showToast('Visitor promoted successfully!', 'green');
                    setTimeout(() => location.reload(), 600);
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        async function handleLinkCustomer() {
            const activeTab = document.querySelector('#linkCustomerTabs .nav-link.active');
            const mode = activeTab ? activeTab.textContent.trim() : 'Existing';

            if (mode === 'Existing') {
                const select = document.getElementById('linkCustomerSelect');
                const customerId = select.value ? parseInt(select.value) : null;
                await linkCustomerById(customerId);
            } else {
                const first = document.getElementById('newCustFirst').value.trim();
                const last = document.getElementById('newCustLast').value.trim();
                const email = document.getElementById('newCustEmail').value.trim();
                const phone = document.getElementById('newCustPhone').value.trim();

                if (!first || !last || !email) {
                    alert('First Name, Last Name, and Email are required.');
                    return;
                }

                const res = await fetch('/api/customer/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: first + ' ' + last, email, phone })
                });
                const data = await res.json();

                if (data.ok && data.id) {
                    await linkCustomerById(data.id);
                    location.reload();
                } else {
                    alert('Error creating customer: ' + (data.error || 'Unknown error'));
                }
            }
        }

        async function linkCustomerById(customerId) {
            await fetch(`/api/chat/session/${currentSessionId}/link-customer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customer_id: customerId })
            });
            const modalEl = document.getElementById('linkCustomerModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            // Refresh to show changes if not reloading
            if (!document.querySelector('#linkCustomerTabs .nav-link.active').textContent.includes('Create')) {
                selectChat(currentSessionId);
            }
        }

        // ===== LINK INQUIRY =====
        function openLinkInquiryModal() {
            const modal = new bootstrap.Modal(document.getElementById('linkInquiryModal'));
            modal.show();
            // Autofill customer name from chat if empty
            const name = document.getElementById('chatHeaderName').textContent.trim();
            const inqNameInput = document.getElementById('newInqCustomer');
            if (name && !inqNameInput.value) {
                inqNameInput.value = name;
            }
        }

        async function handleLinkInquiry() {
            const activeTab = document.querySelector('#linkInquiryTabs .nav-link.active');
            const mode = activeTab ? activeTab.textContent.trim() : 'Existing';

            if (mode === 'Existing') {
                const select = document.getElementById('linkInquirySelect');
                const inquiryId = select.value ? parseInt(select.value) : null;
                await linkInquiryById(inquiryId);
            } else {
                const customer = document.getElementById('newInqCustomer').value.trim();
                const type = document.getElementById('newInqType').value;
                const desc = document.getElementById('newInqDesc').value.trim();

                if (!customer || !desc) {
                    alert('Customer Name and Description are required.');
                    return;
                }

                const res = await fetch('/api/inquiry/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: customer,
                        inquiry_type: type,
                        description: desc,
                        status: 'New',
                        linked_session_id: currentSessionId // Auto-links
                    })
                });
                const data = await res.json();

                if (data.ok) {
                    location.reload();
                } else {
                    alert('Error creating inquiry.');
                }
            }
        }

        async function linkInquiryById(inquiryId) {
            await fetch(`/api/chat/session/${currentSessionId}/link-inquiry`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inquiry_id: inquiryId })
            });

            const modalEl = document.getElementById('linkInquiryModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            selectChat(currentSessionId);
        }

        // ===== UPDATE LINKED BADGES =====
        function updateLinkedBadges(session) {
            const custBadge = document.getElementById('linkedCustomerBadge');
            const inqBadge = document.getElementById('linkedInquiryBadge');

            if (session.linked_customer_id) {
                const select = document.getElementById('linkCustomerSelect');
                const opt = select.querySelector(`option[value="${session.linked_customer_id}"]`);
                if (opt) {
                    custBadge.className = 'chat-link-badge';
                    custBadge.textContent = 'üë§ ' + opt.text;
                    select.value = session.linked_customer_id;
                }
            } else {
                custBadge.className = 'chat-link-badge unlinked';
                custBadge.textContent = 'üë§ No customer linked';
            }

            if (session.linked_inquiry_id) {
                const select = document.getElementById('linkInquirySelect');
                const opt = select.querySelector(`option[value="${session.linked_inquiry_id}"]`);
                if (opt) {
                    inqBadge.className = 'chat-link-badge';
                    inqBadge.textContent = 'üìã ' + opt.text;
                    select.value = session.linked_inquiry_id;
                }
            } else {
                inqBadge.className = 'chat-link-badge unlinked';
                inqBadge.textContent = 'üìã No inquiry linked';
            }
        }

        // ===== SEARCH/FILTER =====
        // ===== EDIT MESSAGE =====
        function editMessage(msgId, btn) {
            const bubble = btn.closest('.chat-bubble');
            // Specifically target the message content div
            const textDiv = bubble.querySelector('.msg-content');

            if (!textDiv) return;

            const currentText = textDiv.innerText;
            const editContainer = document.createElement('div');
            editContainer.className = 'edit-container';
            editContainer.innerHTML = `
                <textarea class="form-control form-control-sm mb-1" style="font-size:0.9em; overflow:hidden; resize:none;">${currentText}</textarea>
                <div class="d-flex justify-content-end gap-1">
                    <button class="btn btn-sm btn-gray py-0 px-2" style="font-size:0.75rem" onclick="cancelEdit(this)">Cancel</button>
                    <button class="btn btn-sm btn-blue py-0 px-2" style="font-size:0.75rem" onclick="saveMessageEdit(${msgId}, this)">Save</button>
                </div>
            `;

            textDiv.style.display = 'none';
            textDiv.insertAdjacentElement('afterend', editContainer);

            // Dynamic resize logic (Width & Height)
            const textarea = editContainer.querySelector('textarea');

            function autoResize() {
                // 1. Calculate Width
                // Create a temporary hidden span to measure text width
                const span = document.createElement('span');
                span.style.visibility = 'hidden';
                span.style.whiteSpace = 'pre-wrap'; // specific to textarea behavior
                span.style.font = window.getComputedStyle(textarea).font;
                span.style.padding = window.getComputedStyle(textarea).padding;
                span.innerText = textarea.value || textarea.placeholder;
                document.body.appendChild(span);

                // Get the width of the text + some padding
                const textWidth = span.offsetWidth + 20;
                document.body.removeChild(span);

                // Constrain width: min 150px, max 100% of parent container
                const maxWidth = textarea.parentElement.parentElement.offsetWidth; // approximate bubble width
                let newWidth = Math.max(150, Math.min(textWidth, maxWidth));

                textarea.style.width = newWidth + 'px';

                // 2. Calculate Height
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight + 2) + 'px';
            }

            // Set initial size
            autoResize();

            // Auto-resize on type
            textarea.addEventListener('input', autoResize);

            // Focus and cursor to end
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Store original text
            editContainer.dataset.original = currentText;

            // Hide buttons
            const actions = bubble.querySelector('.msg-actions');
            if (actions) actions.style.display = 'none';
        }

        function cancelEdit(btn) {
            const container = btn.closest('.edit-container');
            const bubble = container.closest('.chat-bubble');
            const textDiv = bubble.querySelector('.msg-content');

            if (textDiv) textDiv.style.display = '';
            container.remove();

            const actions = bubble.querySelector('.msg-actions');
            if (actions) actions.style.display = '';
        }

        async function saveMessageEdit(msgId, btn) {
            const container = btn.closest('.edit-container');
            const textarea = container.querySelector('textarea');
            const newText = textarea.value.trim();

            if (!newText) {
                if (typeof showToast === 'function') showToast("Message cannot be empty.", "red");
                else alert("Message cannot be empty.");
                return;
            }

            try {
                const res = await fetch(`/api/chat/message/${msgId}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });
                const data = await res.json();

                if (data.ok) {
                    const bubble = container.closest('.chat-bubble');
                    // The text div
                    const textDiv = bubble.querySelector('.msg-content');

                    if (textDiv) {
                        textDiv.innerText = data.text; 
                        textDiv.style.display = '';
                    }
                    container.remove();

                    const actions = bubble.querySelector('.msg-actions');
                    if (actions) actions.style.display = '';
                    if (typeof showToast === 'function') showToast("Message updated.", "green");
                } else {
                    if (typeof showToast === 'function') showToast(data.error || "Error saving message.", "red");
                    else alert(data.error || "Error saving message.");
                }
            } catch (err) {
                if (typeof showToast === 'function') showToast("Error connecting to server.", "red");
                else alert("Error connecting to server.");
            }
        }

        function filterChatList() {
            const q = document.getElementById('chatSearchInput').value.toLowerCase();
            document.querySelectorAll('.chat-list-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const preview = (item.querySelector('.chat-preview')?.textContent || '').toLowerCase();
                const tags = (item.dataset.tags || '').toLowerCase();
                item.style.display = (name.includes(q) || preview.includes(q) || tags.includes(q)) ? '' : 'none';
            });
        }
        // Use the standardized showAgentProfile from app.js
        // This function is defined globally in app.js and will be used across all pages


        // showTeamDetails is now standardized in app.js
        async function showVisitorProfile(sessionId) {
            try {
                const res = await fetch(`/api/chat/session/${sessionId}/profile`);
                if (!res.ok) throw new Error('Failed to fetch profile');
                const data = await res.json();
                const s = data.session;
                const c = data.customer;

                // Set Name & ID
                document.getElementById('vpName').textContent = s.visitor_name;
                document.getElementById('vpID').textContent = 'EXT-' + String(s.id).padStart(6, '0');

                // Initials
                const parts = s.visitor_name.trim().split(' ');
                const initials = parts[0][0] + (parts.length > 1 ? parts[parts.length - 1][0] : '');
                document.getElementById('vpInitials').textContent = initials.toUpperCase();

                // Details
                document.getElementById('vpEmail').textContent = s.visitor_email || 'Not Provided';
                document.getElementById('vpPhone').textContent = s.visitor_phone || 'Not Provided';
                document.getElementById('vpChannel').textContent = s.discovery_channel || 'Direct Visit';
                document.getElementById('vpLast').textContent = s.updated_at || 'Recently';

                // Customer Section Visibility
                const custSection = document.getElementById('vpCustomerSection');
                const btnContainer = document.getElementById('vpBtnBecome');
                const btnReal = document.getElementById('vpBtnBecomeReal');

                if (c) {
                    custSection.style.display = 'block';
                    btnContainer.style.display = 'none';
                    document.getElementById('vpCustID').textContent = 'CUS-' + String(c.id).padStart(6, '0');
                    document.getElementById('vpLoc').textContent = c.location || 'Singapore';
                    document.getElementById('vpStaff').textContent = c.assigned_staff;
                    document.getElementById('vpNotes').textContent = c.notes || 'No internal notes available.';

                    // Tags
                    const tagBox = document.getElementById('vpTags');
                    tagBox.innerHTML = '';
                    if (c.tags) {
                        c.tags.split(',').forEach(tag => {
                            const span = document.createElement('span');
                            span.className = 'badge rounded-pill bg-light text-dark border me-1 px-3 py-1';
                            span.style.fontSize = '0.7rem';
                            span.textContent = tag.trim();
                            tagBox.appendChild(span);
                        });
                    } else {
                        tagBox.innerHTML = '<span class="text-muted small">No tags</span>';
                    }
                } else {
                    custSection.style.display = 'none';
                    btnContainer.style.display = 'block';
                    btnReal.onclick = () => listAsCustomerInModal(s.id);
                    btnReal.disabled = false;
                    btnReal.innerHTML = `<span class="fs-4">‚ú®</span>
                                    <span class="fw-bold small">Promote to Customer</span>
                                    <span class="text-muted" style="font-size: 0.65rem;">Add to your permanent CRM directory</span>`;
                }

                const modal = new bootstrap.Modal(document.getElementById('visitorProfileModal'));
                modal.show();
            } catch (err) {
                console.error(err);
                alert('Could not load profile.');
            }
        }

        async function listAsCustomerInModal(sessionId) {
            const btn = document.getElementById('vpBtnBecomeReal');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm mb-2"></span><span class="fw-bold small">Processing...</span>';

            try {
                const res = await fetch(`/api/chat/session/${sessionId}/become-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.ok) {
                    // Success! 
                    bootstrap.Modal.getInstance(document.getElementById('visitorProfileModal')).hide();
                    // Slight delay for smoothness
                    setTimeout(() => {
                        showVisitorProfile(sessionId);
                        selectChat(sessionId);
                    }, 400);
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = `<span class="fs-4">‚ú®</span><span class="fw-bold small">Promote to Customer</span>`;
                }
            } catch (err) {
                console.error(err);
                alert('Network error.');
                btn.disabled = false;
                btn.innerHTML = `<span class="fs-4">‚ú®</span><span class="fw-bold small">Promote to Customer</span>`;
            }
        }

    </script>

    <!-- Visitor/Customer Profile Modal -->
    <div class="modal fade" id="visitorProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
                <div class="modal-header border-0 pb-0 pt-4 px-4">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div class="d-flex justify-content-center mb-3">
                            <div
                                style="width: 100px; height: 100px; border-radius: 35px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; color: var(--blue); box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 4px solid white;">
                                <div id="vpInitials"></div>
                            </div>
                        </div>
                        <h3 id="vpName" class="fw-bold mb-1"></h3>
                        <p id="vpID" class="text-muted small fw-bold mb-2"></p>
                        <span class="badge rounded-pill bg-light border px-3 py-1 mb-4"
                            style="font-size: 0.7rem; color: #000000;">
                            External Customer
                        </span>
                    </div>

                    <div class="row g-4">
                        <!-- Visitor Details Column -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3 text-uppercase"
                                style="font-size: 0.75rem; color: #64748b; letter-spacing: 0.05em;">Visitor Details</h6>
                            <div class="space-y-3">
                                <div class="p-3 border rounded-4 bg-light/50 mb-2">
                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Email</label>
                                    <span id="vpEmail" class="small d-block text-truncate"></span>
                                </div>
                                <div class="p-3 border rounded-4 bg-light/50 mb-2">
                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Phone</label>
                                    <span id="vpPhone" class="small d-block"></span>
                                </div>
                                <div class="p-3 border rounded-4 bg-light/50 mb-2">
                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Discovery Channel</label>
                                    <span id="vpChannel" class="small d-block"></span>
                                </div>
                                <div class="p-3 border rounded-4 bg-light/50">
                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Last Active</label>
                                    <span id="vpLast" class="small d-block"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Info Column (Conditional) -->
                        <div class="col-md-6">
                            <div id="vpCustomerSection">
                                <h6 class="fw-bold mb-3 text-uppercase"
                                    style="font-size: 0.75rem; color: #64748b; letter-spacing: 0.05em;">Linked Customer
                                    Profile</h6>
                                <div class="p-3 border border-primary/20 rounded-4 bg-primary/5 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span id="vpCustID" class="badge bg-primary rounded-pill small"></span>
                                        <span id="vpLoc" class="small text-muted"></span>
                                    </div>
                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Assigned Staff</label>
                                    <span id="vpStaff" class="small fw-bold d-block mb-2"></span>

                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Tags</label>
                                    <div id="vpTags" class="mb-2"></div>

                                    <label class="d-block small text-muted text-uppercase fw-bold mb-1"
                                        style="font-size: 0.6rem;">Internal Notes</label>
                                    <p id="vpNotes" class="small text-secondary mb-0" style="line-height: 1.5;"></p>
                                </div>
                            </div>

                            <div id="vpBtnBecome">
                                <h6 class="fw-bold mb-3 text-uppercase"
                                    style="font-size: 0.75rem; color: #64748b; letter-spacing: 0.05em;">CRM Actions</h6>
                                <button id="vpBtnBecomeReal" onclick=""
                                    class="btn btn-outline-primary w-100 py-3 rounded-4 d-flex flex-column align-items-center justify-content-center gap-1 border-dashed">
                                    <span class="fs-4">‚ú®</span>
                                    <span class="fw-bold small">Promote to Customer</span>
                                    <span class="text-muted" style="font-size: 0.65rem;">Add to your permanent CRM
                                        directory</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-blue w-100 py-3 fw-bold" data-bs-dismiss="modal"
                        style="border-radius: 16px;">Close Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Profile Modal is now standardized and injected by app.js -->


    <!-- Team Details Modal is now standardized and injected by app.js -->


    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-body p-4 text-center">
                    <div id="confirmIcon" class="mb-3" style="font-size: 3rem;">‚ùì</div>
                    <h5 id="confirmTitle" class="fw-bold mb-2">Are you sure?</h5>
                    <p id="confirmMessage" class="text-muted small mb-4"></p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light flex-grow-1" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirmActionBtn" class="btn btn-primary flex-grow-1">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forced Transfer Modal (Super Admin) -->
    <div class="modal fade" id="adminTransferModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">üõ°Ô∏è Admin Force Transfer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Select an agent to forcefully transfer this conversation to. This
                        agent will immediately gain full control and typing permissions.</p>
                    <label class="form-label small fw-bold">Select Target Agent</label>
                    <select id="adminTransferAgentSelect" class="form-select">
                        <option value="">-- Select Agent --</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.name }} (@{{ u.username }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-blue" onclick="executeAdminTransfer()">Transfer Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST SYSTEM -->
    <div id="siteToast" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>