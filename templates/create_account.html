<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Accounts - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .account-form-card {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-pic-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-light);
            margin-bottom: 1rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #edf2f7;
        }
    </style>
</head>

<body id="page-admin-accounts"
    class="{% if current_theme and current_theme != 'light' %}theme-{{ current_theme }}{% endif %}">
    <aside class="sidebar">
        <h2>CRM Admin</h2>
        <a href="/dashboard" class="nav-link nav-dashboard">Dashboard</a>
        <a href="/customers" class="nav-link nav-customers">Customer List</a>
        <a href="/templates-manager" class="nav-link nav-templates">Template Manager</a>
        <a href="/history" class="nav-link nav-history">Chat History</a>
        <a href="/repository" class="nav-link nav-repository">Inquiry Repository</a>
        <a href="/scoring" class="nav-link nav-scoring">Lead Scoring</a>
        {% if session.get('user_role') in ['super_admin', 'admin'] %}
        <a href="/admin/create-account" class="nav-link nav-admin active">Manage Accounts</a>
        {% endif %}
        <div class="mt-auto pt-3 border-top border-secondary" style="border-color: rgba(255,255,255,0.1) !important;">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar-circle bg-primary text-white me-2"
                        style="width: 32px; height: 32px; font-size: 14px; display:flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden;">
                        {% if session.get('user_pic') and 'http' in session.get('user_pic') %}
                        <img src="{{ session.get('user_pic') }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% elif session.get('user_pic') %}
                        <img src="{{ url_for('static', filename='uploads/' + session.get('user_pic')) }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% else %}
                        {{ session.get('user_name', 'Admin')[0] | upper }}
                        {% endif %}
                    </div>
                    <strong>{{ session.get('user_name', 'Admin') }}</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="/profile">Edit Profile</a></li>
                    <li><a class="dropdown-item" href="/settings">Settings</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="/logout">Sign out</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <div class="header-left">
                <h1 style="margin:0; font-size: 24px;">Manage Accounts</h1>
            </div>
            <div class="header-right"></div>
        </div>

        <div class="content-body" style="padding: 30px;">
            {% if promotion_requests %}
            <div class="alert alert-info border-0 shadow-sm" style="background: rgba(13, 202, 240, 0.1);">
                <h4 class="alert-heading h5 fw-bold text-info"><i class="me-2">üì¢</i>Pending Promotion Requests</h4>
                <p class="mb-2 text-muted small">The following users have been requested for promotion to Super Admin.
                    All Super Admins must approve.</p>
                <div class="list-group">
                    {% for req in promotion_requests %}
                    <div
                        class="list-group-item d-flex justify-content-between align-items-center bg-white border-0 mb-2 rounded shadow-sm p-3">
                        <div>
                            <strong>{{ req.target_user.name }}</strong> (@{{ req.target_user.username }})
                            <div class="small text-muted">
                                Requested by <strong>{{ req.requester.name }}</strong> on {{ req.created_at }}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% set approvals = req.approvals | from_json %}
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-light text-secondary border">
                                    Approved: {{ approvals|length }} / {{ total_super_admins }}
                                </span>
                                {% if session.get('user_id') in approvals %}
                                <span class="badge bg-success-subtle text-success px-3 py-2">Approved</span>
                                {% else %}
                                <button class="btn btn-sm btn-success"
                                    onclick="approvePromotion({{ req.id }}, {{ approvals|length }}, {{ total_super_admins }})">Approve</button>
                                <button class="btn btn-sm btn-danger"
                                    onclick="rejectPromotion({{ req.id }})">Reject</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if session.get('user_role') == 'super_admin' %}
            <div class="account-form-card mb-5">
                <h3 class="form-section-title">Create New Team Account</h3>

                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if success %}
                <div class="alert alert-success">{{ success }}</div>
                {% endif %}

                <form action="{{ url_for('admin_create_account') }}" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <img id="avatarPreview"
                                src="https://ui-avatars.com/api/?name=New+User&background=6366f1&color=fff"
                                class="profile-pic-preview" alt="Preview">
                            <label class="btn btn-sm btn-outline-primary d-block mx-auto mb-2"
                                style="max-width: 150px;">
                                Upload Photo
                                <input type="file" name="profile_picture" id="profilePicInput" hidden accept="image/*">
                            </label>
                            <small class="text-muted">JPG, PNG allowed</small>
                        </div>
                        <div class="col-md-8 px-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Username</label>
                                    <input type="text" name="username" class="form-control" required
                                        placeholder="john.doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Password</label>
                                    <input type="password" name="password" class="form-control" required
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Display Name</label>
                                    <input type="text" name="name" class="form-control" required placeholder="John Doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Account Role</label>
                                    <select name="role" class="form-select">
                                        <option value="agent">Agent (Standard)</option>
                                        <option value="admin">Admin (Manage & Announcements)</option>
                                        <option value="super_admin">Super Admin (Full Access)</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Biography</label>
                                    <textarea name="bio" class="form-control" rows="3"
                                        placeholder="Tell us about this team member..."></textarea>
                                </div>
                                <div class="col-12 text-end mt-4">
                                    <button type="submit" class="btn btn-blue px-4">Create Account</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Existing Accounts List -->
            <div class="card shadow-sm border-0" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <h3 class="form-section-title">Existing Accounts</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">User</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3"
                                                style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                                                {% if user.profile_picture and 'http' in user.profile_picture %}
                                                <img src="{{ user.profile_picture }}" alt="User"
                                                    style="width: 100%; height: 100%; object-fit: cover;">
                                                {% elif user.profile_picture %}
                                                <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}"
                                                    alt="User" style="width: 100%; height: 100%; object-fit: cover;">
                                                {% else %}
                                                <div
                                                    class="bg-light text-primary d-flex align-items-center justify-content-center w-100 h-100 fw-bold">
                                                    {{ user.username[0] | upper }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ user.name }}</div>
                                                <div class="text-muted small">@{{ user.username }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {{ 'bg-primary-subtle text-primary' if user.role == 'super_admin' else ('bg-info-subtle text-info' if user.role == 'admin' else 'bg-secondary-subtle text-secondary') }} px-3 py-2">
                                            {{ 'Super Admin' if user.role == 'super_admin' else ('Admin' if user.role ==
                                            'admin' else 'Agent') }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set status = user.status_display %}
                                        <span
                                            class="badge {{ 'bg-success-subtle text-success' if status == 'Active' else 'bg-secondary-subtle text-secondary' }} px-2 py-1"
                                            style="font-size: 0.7rem;">{{ status | upper }}</span>
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="viewUser({{ user.id }})" title="View Profile">
                                                üëÅÔ∏è
                                            </button>

                                            {% set can_edit = (session.get('user_role') == 'super_admin') or
                                            (session.get('user_role') == 'admin' and user.role == 'agent') %}
                                            <button class="btn btn-sm btn-outline-warning"
                                                onclick="editUser({{ user.id }})" title="Edit Account" {% if not
                                                can_edit %}disabled style="opacity:0.5; cursor:not-allowed;" {% endif
                                                %}>
                                                ‚úèÔ∏è
                                            </button>

                                            {% set can_delete = (session.get('user_role') == 'super_admin' and user.role
                                            != 'super_admin') or (session.get('user_role') == 'admin' and user.role ==
                                            'agent') %}
                                            {% if session.get('user_id') == user.id %}
                                            {% set can_delete = false %}
                                            {% endif %}
                                            {% if user.username == '252499L' %}
                                            {% set can_delete = false %}
                                            {% endif %}

                                            <button class="btn btn-sm btn-outline-danger"
                                                onclick="confirmDeleteUser({{ user.id }}, '{{ user.username }}')"
                                                title="Delete Account" {% if not can_delete %}disabled
                                                style="opacity:0.5; cursor:not-allowed;" {% endif %}>
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal View User -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="avatar-circle mx-auto mb-3"
                        style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 3px solid #eee;">
                        <img id="viewUserPic" src="" alt="User" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h4 id="viewUserName" class="fw-bold mb-1"></h4>
                    <p id="viewUserHandle" class="text-primary mb-3"></p>
                    <div class="mb-3">
                        <span id="viewUserRole" class="badge bg-primary-subtle text-primary px-3 py-2"></span>
                    </div>
                    <div class="text-start px-4">
                        <label class="fw-bold small text-muted">Biography</label>
                        <p id="viewUserBio" class="bg-light p-3 rounded" style="font-size: 0.9rem;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit User -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Edit Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3 text-center">
                            <img id="editUserPicPreview" src="" class="profile-pic-preview" alt="Preview">
                            <input type="file" name="profile_picture" id="editUserPicInput"
                                class="form-control form-control-sm mt-2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Display Name</label>
                            <input type="text" name="name" id="editUserName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Role</label>
                            <select name="role" id="editUserRole" class="form-select" {% if session.get('user_role')
                                !='super_admin' %}disabled{% endif %}>
                                <option value="agent">Agent (Standard)</option>
                                <option value="admin">Admin (Manage & Announcements)</option>
                                <option value="super_admin">Super Admin (Full Access)</option>
                            </select>
                            {% if session.get('user_role') != 'super_admin' %}
                            <input type="hidden" name="role" id="hiddenEditUserRole">
                            <small class="text-muted d-block mt-1">Only Super Admins can change roles.</small>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Bio</label>
                            <textarea name="bio" id="editUserBio" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Update Password (Optional)</label>
                            <input type="password" name="password" class="form-control"
                                placeholder="Leave blank to keep current">
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-blue">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Delete Confirm -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-body text-center py-4">
                    <div class="text-danger mb-3" style="font-size: 3rem;">‚ö†Ô∏è</div>
                    <h5 class="fw-bold">Delete Account?</h5>
                    <p class="text-muted small px-3">Are you sure you want to delete <span id="deleteUserNameDisplay"
                            class="fw-bold"></span>?</p>
                    <input type="hidden" id="deleteUserId">
                    <div class="d-flex gap-2 justify-content-center mt-4">
                        <button type="button" class="btn btn-gray w-100" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger w-100" onclick="executeDelete()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-body text-center py-4">
                    <div id="confirmIcon" class="mb-3" style="font-size: 3rem;">‚ö†Ô∏è</div>
                    <h5 id="confirmTitle" class="fw-bold">Are you sure?</h5>
                    <p id="confirmMessage" class="text-muted small px-3"></p>
                    <div class="d-flex gap-2 justify-content-center mt-4">
                        <button type="button" class="btn btn-gray w-100" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirmActionBtn" class="btn btn-primary w-100">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Profile Pic Preview for Creation
        document.getElementById('profilePicInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // VIEW USER
        async function viewUser(userId) {
            const res = await fetch(`/api/admin/user/${userId}`);
            if (res.ok) {
                const data = await res.json();
                document.getElementById('viewUserName').textContent = data.name;
                document.getElementById('viewUserHandle').textContent = `@${data.username}`;
                document.getElementById('viewUserRole').textContent =
                    data.role === 'super_admin' ? 'Super Admin' :
                        data.role === 'admin' ? 'Admin' : 'Agent';

                // Update badge color
                const badge = document.getElementById('viewUserRole');
                badge.className = 'badge px-3 py-2 ' + (
                    data.role === 'super_admin' ? 'bg-primary-subtle text-primary' :
                        data.role === 'admin' ? 'bg-info-subtle text-info' :
                            'bg-secondary-subtle text-secondary'
                );
                document.getElementById('viewUserBio').textContent = data.bio || 'No biography available.';

                const picUrl = data.profile_picture ?
                    (data.profile_picture.startsWith('http') ? data.profile_picture : `/static/uploads/${data.profile_picture}`) :
                    `https://ui-avatars.com/api/?name=${data.name}&background=random`;
                document.getElementById('viewUserPic').src = picUrl;

                const modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                modal.show();
            }
        }

        // EDIT USER
        async function editUser(userId) {
            const res = await fetch(`/api/admin/user/${userId}`);
            if (res.ok) {
                const data = await res.json();
                const form = document.getElementById('editUserForm');
                form.action = `/admin/edit-account/${userId}`;

                document.getElementById('editUserName').value = data.name;
                document.getElementById('editUserRole').value = data.role;
                document.getElementById('editUserBio').value = data.bio || '';

                const picUrl = data.profile_picture ?
                    (data.profile_picture.startsWith('http') ? data.profile_picture : `/static/uploads/${data.profile_picture}`) :
                    `https://ui-avatars.com/api/?name=${data.name}&background=random`;
                document.getElementById('editUserPicPreview').src = picUrl;

                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
        }

        // DELETE USER
        function confirmDeleteUser(id, username) {
            document.getElementById('deleteUserId').value = id;
            document.getElementById('deleteUserNameDisplay').textContent = `@${username}`;
            const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            modal.show();
        }

        async function executeDelete() {
            const userId = document.getElementById('deleteUserId').value;
            const res = await fetch(`/admin/delete-account/${userId}`, { method: 'POST' });
            if (res.ok) {
                window.location.reload();
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to delete account');
            }
        }

        // PROMOTION REQUESTS
        // PROMOTION REQUESTS
        let pendingAction = null;
        let pendingReqId = null;

        function showConfirmation(title, message, icon, action, reqId, confirmBtnClass = 'btn-primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').textContent = icon;

            const btn = document.getElementById('confirmActionBtn');
            btn.className = `btn w-100 ${confirmBtnClass}`;
            btn.onclick = executeConfirmation;

            pendingAction = action;
            pendingReqId = reqId;

            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        async function executeConfirmation() {
            const modalEl = document.getElementById('confirmationModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            if (!pendingAction || !pendingReqId) return;

            const url = pendingAction === 'approve'
                ? `/admin/approve-promotion/${pendingReqId}`
                : `/admin/reject-promotion/${pendingReqId}`;

            try {
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    // Small delay to allow modal to close smoothly
                    setTimeout(() => window.location.reload(), 300);
                } else {
                    alert(data.error || 'Action failed');
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }

        function approvePromotion(reqId, currentApprovals, totalAdmins) {
            // New approval count will be current + 1 (the current user)
            const nextCount = currentApprovals + 1;

            showConfirmation(
                'Approve Promotion?',
                `This request has currently been approved by ${currentApprovals} out of ${totalAdmins} Super Admins.\n\nAfter your approval, it will be ${nextCount} / ${totalAdmins}.\n\nAre you sure you want to approve?`,
                '‚úÖ',
                'approve',
                reqId,
                'btn-success'
            );
        }

        function rejectPromotion(reqId) {
            showConfirmation(
                'Reject Promotion?',
                'Are you sure you want to reject this promotion request?',
                'üö´',
                'reject',
                reqId,
                'btn-danger'
            );
        }
    </script>
</body>

</html>