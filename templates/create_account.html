<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Accounts - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .account-form-card {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-pic-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-light);
            margin-bottom: 1rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #edf2f7;
        }

        .team-bubble:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05) !important;
            border-color: #6366f1 !important;
        }

        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body id="page-admin-accounts"
    class="{% if current_theme and current_theme != 'light' %}theme-{{ current_theme }}{% endif %}">
    <aside class="sidebar">
        <h2>CRM Admin</h2>
        <a href="/dashboard" class="nav-link nav-dashboard">Dashboard</a>
        <a href="/customers" class="nav-link nav-customers">Customer List</a>
        <a href="/my-team" class="nav-link nav-my-team d-flex justify-content-between align-items-center">
            My Team
            <div class="d-flex align-items-center gap-1">
                {% if unread_team_messages %}
                <span class="rounded-circle bg-warning" style="width: 10px; height: 10px; display: inline-block;"></span>
                {% endif %}
                {% if team_pending_requests_count and team_pending_requests_count > 0 %}
                <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.9em;"></i>
                {% endif %}
            </div>
        </a>
        <a href="/templates-manager" class="nav-link nav-templates">Template Manager</a>
        <a href="/history" class="nav-link nav-history d-flex justify-content-between align-items-center">
            Chat History
            {% if transfer_request_count and transfer_request_count > 0 %}
            <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.9em;"></i>
            {% endif %}
        </a>
        <a href="/repository" class="nav-link nav-repository">Inquiry Repository</a>
        <a href="/scoring" class="nav-link nav-scoring">Lead Scoring</a>
        {% if session.get('user_role') in ['ultra_admin', 'super_admin', 'admin'] %}
        <a href="/admin/create-account" class="nav-link nav-admin active">
            Manage Accounts
            {% if pending_promotion_count and pending_promotion_count > 0 %}
            <span class="badge bg-danger ms-2" style="font-size: 0.7em;">!</span>
            {% endif %}
        </a>
        {% endif %}
        <div class="mt-auto pt-3 border-top border-secondary" style="border-color: rgba(255,255,255,0.1) !important;">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar-circle bg-primary text-white me-2"
                        style="width: 32px; height: 32px; font-size: 14px; display:flex; align-items:center; justify-content:center; border-radius:50%; overflow:hidden;">
                        {% if session.get('user_pic') and 'http' in session.get('user_pic') %}
                        <img src="{{ session.get('user_pic') }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% elif session.get('user_pic') %}
                        <img src="{{ url_for('static', filename='uploads/' + session.get('user_pic')) }}" alt="User"
                            style="width:100%; height:100%; object-fit:cover;">
                        {% else %}
                        {{ session.get('user_name', 'Admin')[0] | upper }}
                        {% endif %}
                    </div>
                    <strong>{{ session.get('user_name', 'Admin') }}</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="/profile">Edit Profile</a></li>
                    <li><a class="dropdown-item" href="/settings">Settings</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="/logout">Sign out</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <div class="header-left">
                <h1 style="margin:0; font-size: 24px;">Manage Accounts</h1>
            </div>
            <div class="header-right"></div>
        </div>

        <div class="content-body" style="padding: 30px;">
            {% if promotion_requests %}
            <div class="alert alert-info border-0 shadow-sm" style="background: rgba(13, 202, 240, 0.1);">
                <h4 class="alert-heading h5 fw-bold text-info"><i class="me-2">üì¢</i>Pending Promotion Requests</h4>
                <p class="mb-2 text-muted small">The following users have been requested for promotion to Super Admin.
                    All Super Admins must approve.</p>
                <div class="list-group">
                    {% for req in promotion_requests %}
                    <div
                        class="list-group-item d-flex justify-content-between align-items-center bg-white border-0 mb-2 rounded shadow-sm p-3">
                        <div>
                            <strong>{{ req.target_user.name }}</strong> (@{{ req.target_user.username }})
                            <div class="small text-muted">
                                Requested by <strong>{{ req.requester.name }}</strong> on {{ req.created_at }}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% set approvals = req.approvals | from_json %}
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-light text-secondary border">
                                    Approved: {{ approvals|length }} / {{ total_super_admins }}
                                </span>
                                {% if session.get('user_id')|string in approvals %}
                                <span class="badge bg-success-subtle text-success px-3 py-2">Approved</span>
                                {% else %}
                                <button class="btn btn-sm btn-success"
                                    onclick="approvePromotion('{{ req.id }}', '{{ approvals|length }}', '{{ total_super_admins }}')">Approve</button>
                                <button class="btn btn-sm btn-danger"
                                    onclick="rejectPromotion('{{ req.id }}')">Reject</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <!-- My Pending Promotion -->
            {% if my_promotion %}
            <div class="alert alert-warning border-0 shadow-sm mb-4"
                style="border-radius: 16px; background-color: #fff9db; border-left: 5px solid #fcc419 !important;">
                <div class="d-flex align-items-center">
                    <div class="me-3 fs-3">‚è≥</div>
                    <div class="flex-grow-1">
                        <h5 class="fw-bold mb-1" style="color: #856404;">Your Promotion to {{ my_promotion.role }} is
                            Pending</h5>
                        <p class="mb-2 small text-muted">Approval progress: <strong>{{ my_promotion.approvals
                                }}</strong> out of <strong>{{ my_promotion.total_needed }}</strong> Super Admins have
                            approved.</p>
                        <div class="progress" style="height: 10px; border-radius: 10px; background-color: #f1f1f1;">
                            {% set pct = (my_promotion.approvals / my_promotion.total_needed * 100) if
                            my_promotion.total_needed > 0 else 0 %}
                            <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: {{ pct }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if session.get('user_role') in ['ultra_admin', 'super_admin'] %}
            <div class="account-form-card mb-5">
                <h3 class="form-section-title">Create New Team Account</h3>

                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if success %}
                <div class="alert alert-success">{{ success }}</div>
                {% endif %}

                <form action="{{ url_for('admin_create_account') }}" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <img id="avatarPreview"
                                src="https://ui-avatars.com/api/?name=New+User&background=6366f1&color=fff"
                                class="profile-pic-preview" alt="Preview">
                            <label class="btn btn-sm btn-outline-primary d-block mx-auto mb-2"
                                style="max-width: 150px;">
                                Upload Photo
                                <input type="file" name="profile_picture" id="profilePicInput" hidden accept="image/*">
                            </label>
                            <small class="text-muted">JPG, PNG allowed</small>
                        </div>
                        <div class="col-md-8 px-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Username</label>
                                    <input type="text" name="username" class="form-control" required
                                        placeholder="john.doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Password</label>
                                    <input type="password" name="password" class="form-control" required
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Display Name</label>
                                    <input type="text" name="name" class="form-control" required placeholder="John Doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Account Role</label>
                                    <select name="role" class="form-select">
                                        <option value="agent">Agent (Standard)</option>
                                        <option value="admin">Admin (Manage & Announcements)</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Biography</label>
                                    <textarea name="bio" class="form-control" rows="3"
                                        placeholder="Tell us about this team member..."></textarea>
                                </div>
                                <div class="col-12 text-end mt-4">
                                    <button type="submit" class="btn btn-blue px-4">Create Account</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Existing Accounts List -->
            <div class="card shadow-sm border-0" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" id="userListSearch" class="form-control border-start-0"
                                    placeholder="Search by name or handle...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select id="filterRole" class="form-select">
                                <option value="all">All Roles</option>
                                <option value="ultra_admin">Ultra Admin</option>
                                <option value="super_admin">Super Admin</option>
                                <option value="admin">Admin</option>
                                <option value="agent">Agent</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="filterTeam" class="form-select">
                                <option value="all">All Teams</option>
                                {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="filterStatus" class="form-select">
                                <option value="all">All Status</option>
                                <option value="Active">Active Only</option>
                                <option value="Inactive">Inactive Only</option>
                            </select>
                        </div>
                        {% if session.get('user_role') in ['ultra_admin', 'super_admin'] %}
                        <div class="col-md-2 text-end">
                            <button class="btn btn-outline-primary" onclick="scrollToTeams()">
                                <i class="bi bi-people-fill me-1"></i> Manage Teams
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="accountsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">User</th>
                                    <th>Role</th>
                                    <th>Team / Org</th>
                                    <th>Status</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3"
                                                style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                                                {% if user.profile_picture and 'http' in user.profile_picture %}
                                                <img src="{{ user.profile_picture }}" alt="User"
                                                    style="width: 100%; height: 100%; object-fit: cover;">
                                                {% elif user.profile_picture %}
                                                <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}"
                                                    alt="User" style="width: 100%; height: 100%; object-fit: cover;">
                                                {% else %}
                                                <div
                                                    class="bg-light text-primary d-flex align-items-center justify-content-center w-100 h-100 fw-bold">
                                                    {{ user.username[0] | upper }}
                                                </div>
                                                {% endif %}
                                            </div>
                                             <div style="cursor: pointer;" onclick="showAgentProfile('{{ user.id }}')">
                                                 <div class="fw-bold">{{ user.name }}</div>
                                                 <div class="text-muted small">@{{ user.username }}</div>
                                             </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.role == 'ultra_admin' %}
                                        <span class="badge role-ultra-admin">Ultra Admin</span>
                                        {% elif user.role == 'super_admin' %}
                                        <span class="badge bg-primary-subtle text-primary">Super Admin</span>
                                        {% elif user.role == 'admin' %}
                                        <span class="badge bg-info-subtle text-info">Admin</span>
                                        {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary">Agent</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.team_obj %}
                                        <div class="d-flex align-items-center" style="cursor: pointer;"
                                            onclick="showTeamDetails('{{ user.team_id }}')">
                                            <span class="badge bg-light text-dark border me-2">{{ user.team_obj.team_tag
                                                or 'TEAM' }}</span>
                                            <span class="small fw-bold">{{ user.team_obj.name }}</span>
                                        </div>
                                        <div class="small text-muted" style="font-size: 0.75rem; margin-left: 2px;">
                                            {{ user.team_role | title if user.team_role else 'Member' }}
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">No Team</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set status = user.status_display %}
                                        <span
                                            class="badge {% if 'Active' in status %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %} px-2 py-1"
                                            style="font-size: 0.7rem;">
                                            {{ status | upper }}
                                        </span>
                                    </td>
                                    <td class="text-end pe-3" data-search-team="{{ user.team_id or 'none' }}"
                                        data-search-role="{{ user.role }}"
                                        data-search-status="{{ 'Active' if 'Active' in status else 'Inactive' }}">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="showAgentProfile('{{ user.id }}')" title="View Profile">
                                                üëÅÔ∏è
                                            </button>

                                            {% set can_edit = (session.get('user_role') in ['ultra_admin',
                                            'super_admin']) or
                                            (session.get('user_role') == 'admin' and user.role == 'agent') %}
                                            <button class="btn btn-sm btn-outline-warning"
                                                onclick="editUser('{{ user.id }}')" title="Edit Account" {% if not
                                                can_edit %}disabled style="opacity:0.5; cursor:not-allowed;" {% endif
                                                %}>
                                                ‚úèÔ∏è
                                            </button>

                                            {% set can_delete = (session.get('user_role') == 'ultra_admin') or
                                            (session.get('user_role') == 'super_admin' and user.role not in
                                            ['super_admin', 'ultra_admin']) or
                                            (session.get('user_role') == 'admin' and user.role == 'agent') %}
                                            {% if session.get('user_id') == user.id %}
                                            {% set can_delete = false %}
                                            {% endif %}
                                            {% if user.username == '252499L' %}
                                            {% set can_delete = false %}
                                            {% endif %}

                                            <button class="btn btn-sm btn-outline-danger"
                                                onclick="confirmDeleteUser('{{ user.id }}', '{{ user.username }}')"
                                                title="Delete Account" {% if not can_delete %}disabled
                                                style="opacity:0.5; cursor:not-allowed;" {% endif %}>
                                                üóëÔ∏è
                                            </button>

                                            {% if user.team_id %}
                                            <button class="btn btn-sm btn-outline-info"
                                                onclick="showTeamDetails('{{ user.team_id }}')" title="View Team Profil">
                                                üë•
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-secondary" disabled title="No Team">
                                                üë•
                                            </button>
                                            {% endif %}

                                            {% if session.get('user_role') in ['ultra_admin', 'super_admin'] or
                                            (session.get('user_role') == 'admin' and user.role == 'agent') %}
                                            <button class="btn btn-sm btn-outline-dark"
                                                onclick="initiateMoveUser('{{ user.id }}')" title="Reassign Team">
                                                üîÑ
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr id="noResultsRow" style="display: none;">
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        <i class="bi bi-search mb-2" style="font-size: 2rem;"></i>
                                        <p>No accounts found matching your filters.</p>
                                        <button class="btn btn-sm btn-link" onclick="clearFilters()">Clear all filters</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% if session.get('user_role') in ['ultra_admin', 'super_admin'] %}
        <!-- Teams Management Section (Visible by default) -->
        <div class="content-body" style="padding: 0 30px 30px 30px;">
            <div id="teamsSection" class="card shadow-sm border-0 mb-5" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="form-section-title mb-0">Teams Management</h3>
                        <div>
                            {% if session.get('user_role') in ['ultra_admin', 'super_admin'] %}
                            <button class="btn btn-blue btn-sm" data-bs-toggle="modal"
                                data-bs-target="#createTeamModal">
                                + Create Team
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- My Team Info -->
                        <div class="col-md-4 border-end">
                            <h5 class="small fw-bold text-muted text-uppercase mb-3">My Current Status</h5>
                            {% if my_team_id %}
                            <div class="d-flex align-items-center p-3 border rounded bg-light mb-3">
                                <div class="team-avatar me-3">
                                    <img src="https://ui-avatars.com/api/?name=Team&background=6366f1&color=fff"
                                        class="rounded" style="width: 48px; height: 48px;">
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold" id="myTeamName">Loading...</div>
                                    <div class="small text-primary badge bg-primary-subtle">{{ my_team_role | title }}
                                    </div>
                                </div>
                            </div>
                            {% if team_pending_requests_count > 0 %}
                            <button class="btn btn-warning btn-sm w-100 mb-2" data-bs-toggle="modal"
                                data-bs-target="#teamRequestsModal">
                                üîî Pending Requests ({{ team_pending_requests_count }})
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="leaveTeam()">
                                Leave Current Team
                            </button>
                            {% else %}
                            <div class="alert alert-info py-2 small">
                                You are not currently part of any team.
                            </div>
                            {% endif %}
                        </div>

                        <!-- Available Teams -->
                        <div class="col-md-8">
                            <h5 class="small fw-bold text-muted text-uppercase mb-3">Available Teams</h5>
                            <div class="row row-cols-1 row-cols-md-2 g-3" id="teamsListContainer">
                                <div class="col text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </main>

    <!-- Modal Edit User -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Edit Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3 text-center">
                            <img id="editUserPicPreview" src="" class="profile-pic-preview" alt="Preview">
                            <input type="file" name="profile_picture" id="editUserPicInput"
                                class="form-control form-control-sm mt-2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Display Name</label>
                            <input type="text" name="name" id="editUserName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Role</label>
                            <select name="role" id="editUserRole" class="form-select" {% if session.get('user_role') not
                                in ['ultra_admin', 'super_admin' ] %}disabled{% endif %}>
                                <option value="agent">Agent (Standard)</option>
                                <option value="admin">Admin (Manage & Announcements)</option>
                                <option value="super_admin">Super Admin (Full Access)</option>
                            </select>
                            {% if session.get('user_role') not in ['ultra_admin', 'super_admin'] %}
                            <input type="hidden" name="role" id="hiddenEditUserRole">
                            <small class="text-muted d-block mt-1">Only Super Admins and the Ultra Admin can change
                                roles.</small>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Bio</label>
                            <textarea name="bio" id="editUserBio" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Update Password (Optional)</label>
                            <input type="password" name="password" class="form-control"
                                placeholder="Leave blank to keep current">
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-blue">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Delete Confirm -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-body text-center py-4">
                    <div class="text-danger mb-3" style="font-size: 3rem;">‚ö†Ô∏è</div>
                    <h5 class="fw-bold">Delete Account?</h5>
                    <p class="text-muted small px-3">Are you sure you want to delete <span id="deleteUserNameDisplay"
                            class="fw-bold"></span>?</p>
                    <input type="hidden" id="deleteUserId">
                    <div class="d-flex gap-2 justify-content-center mt-4">
                        <button type="button" class="btn btn-gray w-100" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger w-100" onclick="executeDelete()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-body text-center py-4">
                    <div id="confirmIcon" class="mb-3" style="font-size: 3rem;">‚ö†Ô∏è</div>
                    <h5 id="confirmTitle" class="fw-bold">Are you sure?</h5>
                    <p id="confirmMessage" class="text-muted small px-3"></p>
                    <div class="d-flex gap-2 justify-content-center mt-4">
                        <button type="button" class="btn btn-gray w-100" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirmActionBtn" class="btn btn-primary w-100">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div class="modal fade" id="createTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Create New Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="createTeamForm">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Team Name</label>
                            <input type="text" name="name" class="form-control" required
                                placeholder="e.g. JAANN Support">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Team Tag</label>
                            <input type="text" name="team_tag" class="form-control" placeholder="e.g. SUP"
                                maxlength="5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Role / Purpose</label>
                            <input type="text" name="role" class="form-control" placeholder="e.g. Customer Support">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Team Description</label>
                            <textarea name="description" class="form-control" rows="2"
                                placeholder="Describe the team's mission..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Team Leader</label>
                            <select name="leader_id" class="form-select" {% if me and me.team_id %}required{% endif %}>
                                <option value="">{% if me and me.team_id %}-- Select a Leader (Required) --{% else %}-- Myself (Defualt) --{% endif %}</option>
                                {% for user in users %}
                                    {% if not user.team_id %}
                                    <option value="{{ user.id }}">{{ user.name }} (@{{ user.username }})</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            {% if me and me.team_id %}
                            <small class="text-danger" style="font-size: 0.7rem;">Since you are already in a team, you must assign another user as the leader.</small>
                            {% else %}
                            <small class="text-muted" style="font-size: 0.7rem;">Leave blank to assign yourself as leader.</small>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Team Icon (Optional)</label>
                            <input type="file" name="profile_picture" class="form-control" accept="image/*">
                            <small class="text-muted" style="font-size: 0.7rem;">JPG or PNG recommended.</small>
                        </div>
                        <div class="text-end pt-2">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-blue px-4">Create Team</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Move User Modal -->
    <div class="modal fade" id="moveUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Move User to Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="moveUserId">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Select Destination Team</label>
                        <select id="moveTeamSelect" class="form-select">
                            <option value="none">No Team (Unassign)</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <p class="small text-muted">The user will be notified of their new team assignment.</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-gray" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-blue px-4" onclick="confirmMoveUser()">Move User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Requests Modal -->
    <div class="modal fade" id="teamRequestsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title">Team Requests</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="teamRequestsList">
                        <!-- Loaded via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Team Details Modal is now standardized and injected by app.js -->


    <script>
        // --- Team Request Loading for Leaders ---
        const teamRequestsModalEl = document.getElementById('teamRequestsModal');
        if (teamRequestsModalEl) {
            teamRequestsModalEl.addEventListener('show.bs.modal', loadTeamRequests);
        }

        async function loadTeamRequests() {
            const container = document.getElementById('teamRequestsList');
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

            // Note: We need a new endpoint or reusable logic to fetch pending requests for current user's team.
            // For now, let's assume we can fetch them from a dedicated API.
            const res = await fetch('/api/teams/my-requests');
            const data = await res.json();

            if (!data.requests || data.requests.length === 0) {
                container.innerHTML = '<div class="alert alert-light text-center small">No pending requests.</div>';
                return;
            }

            container.innerHTML = '';
            data.requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center justify-content-between p-3 border rounded mb-2';
                item.innerHTML = `
                    <div>
                        <div class="fw-bold small">${req.user_name}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">Action: ${req.type}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success" onclick="handleTeamRequest(${req.id}, 'approved')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="handleTeamRequest(${req.id}, 'rejected')">Reject</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        async function handleTeamRequest(requestId, status) {
            const res = await fetch('/api/teams/handle-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: requestId, status: status })
            });
            const data = await res.json();
            if (data.success) {
                loadTeamRequests();
                // Optionally reload page to update table
                setTimeout(() => location.reload(), 500);
            } else {
                alert(data.error);
            }
        }
        // Profile Pic Preview for Creation
        document.getElementById('profilePicInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- Search & Filter Logic ---
        function attachFilterListeners() {
            const searchInput = document.getElementById('userListSearch');
            const roleSelect = document.getElementById('filterRole');
            const teamSelect = document.getElementById('filterTeam');
            const statusSelect = document.getElementById('filterStatus');

            if (searchInput) searchInput.addEventListener('input', applyFilters);
            if (roleSelect) roleSelect.addEventListener('change', applyFilters);
            if (teamSelect) teamSelect.addEventListener('change', applyFilters);
            if (statusSelect) statusSelect.addEventListener('change', applyFilters);
        }
        attachFilterListeners();

        // Global User Context for Standardized Modals
        window.currUserId = {{ session.get('user_id', 0) }};
        window.currUserRole = "{{ session.get('user_role', 'agent') }}";
        window.currUsername = "{{ session.get('user_name', '') }}"; // In this app, session['user_name'] is the username Handle

        const filterPrefix = 'userConfig_';

        function applyFilters() {
            try {
                const searchInput = document.getElementById('userListSearch');
                const roleSelect = document.getElementById('filterRole');
                const teamSelect = document.getElementById('filterTeam');
                const statusSelect = document.getElementById('filterStatus');

                if (!searchInput || !roleSelect || !teamSelect || !statusSelect) {
                    console.warn("Filter elements missing skip applyFilters");
                    return;
                }

                const query = searchInput.value.toLowerCase();
                const role = roleSelect.value;
                const team = teamSelect.value;
                const status = statusSelect.value;

                console.log(`Applying filters: q=${query}, r=${role}, t=${team}, s=${status}`);

                // Save to localStorage
                localStorage.setItem(filterPrefix + 'query', query);
                localStorage.setItem(filterPrefix + 'role', role);
                localStorage.setItem(filterPrefix + 'team', team);
                localStorage.setItem(filterPrefix + 'status', status);

                const rows = document.querySelectorAll('#accountsTable tbody tr:not(#noResultsRow)');
                let visibleCount = 0;

                rows.forEach(row => {
                    const searchCell = row.querySelector('[data-search-team]');
                    if (!searchCell) return;
                    
                    const name = row.querySelector('.fw-bold').innerText.toLowerCase();
                    const handle = row.querySelector('.text-muted.small').innerText.toLowerCase();

                    const matchesSearch = name.includes(query) || handle.includes(query);
                    const matchesRole = role === 'all' || searchCell.dataset.searchRole === role;
                    const matchesTeam = team === 'all' || searchCell.dataset.searchTeam === team;
                    const matchesStatus = status === 'all' || searchCell.dataset.searchStatus === status;

                    const show = (matchesSearch && matchesRole && matchesTeam && matchesStatus);
                    row.style.display = show ? '' : 'none';
                    if (show) visibleCount++;
                });

                const noResults = document.getElementById('noResultsRow');
                if (noResults) {
                    noResults.style.display = (visibleCount === 0) ? '' : 'none';
                }
            } catch (err) {
                console.error("applyFilters error:", err);
            }
        }

        function loadSavedFilters() {
            try {
                console.log("Loading saved filters for " + filterPrefix);
                const query = localStorage.getItem(filterPrefix + 'query');
                const role = localStorage.getItem(filterPrefix + 'role');
                const team = localStorage.getItem(filterPrefix + 'team');
                const status = localStorage.getItem(filterPrefix + 'status');

                const searchInput = document.getElementById('userListSearch');
                const roleSelect = document.getElementById('filterRole');
                const teamSelect = document.getElementById('filterTeam');
                const statusSelect = document.getElementById('filterStatus');

                if (query !== null && searchInput) searchInput.value = query;
                if (role !== null && roleSelect) roleSelect.value = role;
                if (team !== null && teamSelect) teamSelect.value = team;
                if (status !== null && statusSelect) statusSelect.value = status;
                
                applyFilters();
            } catch (err) {
                console.error("loadSavedFilters error:", err);
            }
        }

        function clearFilters() {
            const searchInput = document.getElementById('userListSearch');
            const roleSelect = document.getElementById('filterRole');
            const teamSelect = document.getElementById('filterTeam');
            const statusSelect = document.getElementById('filterStatus');

            if (searchInput) searchInput.value = '';
            if (roleSelect) roleSelect.value = 'all';
            if (teamSelect) teamSelect.value = 'all';
            if (statusSelect) statusSelect.value = 'all';

            applyFilters();
        }

        // --- Team Management Logic ---
        function scrollToTeams() {
            document.getElementById('teamsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleTeamSection() {
            scrollToTeams();
        }

        async function loadTeams() {
            try {
                console.log("Starting loadTeams...");
                const res = await fetch('/api/teams?_=' + new Date().getTime());
                if (!res.ok) throw new Error(`API failed with status ${res.status}`);
                const data = await res.json();
                console.log("Teams loaded:", data);
                const container = document.getElementById('teamsListContainer');
                if (!container) {
                    console.error("teamsListContainer not found!");
                    return;
                }

                container.innerHTML = '';
                if (!data.teams || data.teams.length === 0) {
                    container.innerHTML = '<div class="col-12 py-4 text-center text-muted">No teams found.</div>';
                    return;
                }

                let foundMyTeam = false;
                data.teams.forEach(team => {
                    const col = document.createElement('div');
                    col.className = 'col';
                    
                    // Defensive check for team properties
                    const teamName = team.name || 'Unnamed Team';
                    const teamPic = team.profile_picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(teamName)}&background=6366f1&color=fff`;
                    const teamTag = team.team_tag || 'TEAM';
                    const teamDesc = team.description || 'No description.';
                    const memberCount = team.member_count !== undefined ? team.member_count : 0;
                    const teamScore = team.team_score !== undefined ? team.team_score : 0;

                    col.innerHTML = `
                        <div class="card h-100 border p-3 team-bubble shadow-sm hover-shadow" style="cursor: pointer; transition: 0.3s;" onclick="showTeamDetails(${team.id})">
                            <div class="d-flex align-items-center mb-2">
                                <img src="${teamPic}" class="rounded me-2" style="width: 38px; height: 38px; object-fit: cover;">
                                <div class="flex-grow-1 overflow-hidden">
                                    <div class="fw-bold small text-truncate">${teamName}</div>
                                    <div class="text-muted" style="font-size: 0.65rem;">${teamTag}</div>
                                </div>
                            </div>
                            <p class="small text-muted mb-2 text-truncate-2" style="font-size: 0.75rem; height: 32px;">${teamDesc}</p>
                            <div class="d-flex justify-content-between align-items-center mt-auto pt-2 border-top">
                                <span class="small text-muted" style="font-size: 0.7rem;">${memberCount} members</span>
                                <span class="badge bg-primary-subtle text-primary" style="font-size: 0.6rem;">Score: ${teamScore}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);

                    // Update my team name if match
                    const myTeamIdStr = "{{ my_team_id }}";
                    if (myTeamIdStr && String(team.id) === myTeamIdStr) {
                        const el = document.getElementById('myTeamName');
                        if (el) el.textContent = team.name;
                        foundMyTeam = true;
                    }
                });

                if (!foundMyTeam && "{{ my_team_id }}") {
                    const el = document.getElementById('myTeamName');
                    if (el) el.textContent = "Unknown Team";
                }
            } catch (err) {
                console.error("LoadTeams Error:", err);
                const container = document.getElementById('teamsListContainer');
                if (container) container.innerHTML = `<div class="col-12 py-4 text-center text-danger">Failed to load teams: ${err.message}</div>`;
            }
        }

        async function requestJoinTeam(teamId) {
            const res = await fetch('/api/teams/request-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'join',
                    user_id: "{{ session.get('user_id') }}",
                    team_id: teamId
                })
            });
            const data = await res.json();
            if (data.success) {
                alertUser(data.message || 'Request sent!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                alertUser(data.error, 'error');
            }
        }

        async function leaveTeam() {
            askConfirmation(
                "Leave Team?",
                "Are you sure you want to leave your current team?",
                "üö™",
                async () => {
                    const res = await fetch('/api/teams/leave', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) location.reload();
                    else alertUser(data.error, 'error');
                },
                'btn-danger'
            );
        }

        document.getElementById('createTeamForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const res = await fetch('/api/teams/create', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                location.reload();
            } else {
                alert(data.error);
            }
        });

        async function confirmMoveUser() {
            const userId = document.getElementById('moveUserId').value;
            const teamId = document.getElementById('moveTeamSelect').value;

            const res = await fetch('/api/teams/request-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'move',
                    user_id: userId,
                    team_id: teamId
                })
            });
            const data = await res.json();
            if (data.success) {
                location.reload();
            } else {
                alertUser(data.error, 'error');
            }
        }

        // --- Team Details Logic ---
        // showTeamDetails is now standardized in app.js

        function initiateMoveUser(userId) {
            document.getElementById('moveUserId').value = userId;
            const modal = new bootstrap.Modal(document.getElementById('moveUserModal'));
            modal.show();
        }

        async function memberAction(username, action) {
            if (action === 'transfer_leader') {
                askConfirmation(
                    "Transfer Leadership?",
                    `Are you sure you want to transfer leadership to @${username}? You will become a Vice-Leader.`,
                    "üëë",
                    async () => {
                        const res = await fetch('/api/teams/member-action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, action })
                        });

                        if (res.ok) location.reload();
                        else alertUser("Failed to perform action.", 'error');
                    },
                    'btn-warning'
                );
                return;
            }

            const res = await fetch('/api/teams/member-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, action })
            });

            if (res.ok) location.reload();
            else alertUser("Failed to perform action.", 'error');
        }

        async function kickMember(username) {
            askConfirmation(
                "Kick Member?",
                `Are you sure you want to kick @${username} from the team?`,
                "üë¢",
                async () => {
                    const res = await fetch('/api/teams/kick', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username })
                    });

                    if (res.ok) location.reload();
                    else {
                        const data = await res.json();
                        alertUser(data.error || "Failed to kick member.", 'error');
                    }
                },
                'btn-danger'
            );
        }

        async function confirmDeleteTeam(teamId, teamName) {
            askConfirmation(
                "Delete Team?",
                `Are you sure you want to delete "${teamName}"? This will unassign all members.`,
                "üóëÔ∏è",
                async () => {
                    try {
                        const res = await fetch(`/api/teams/${teamId}/delete`, { method: 'POST' });
                        if (res.ok) {
                            window.location.reload();
                        } else {
                            const data = await res.json();
                            alertUser(data.error || "Failed to delete team.", 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        alertUser("An error occurred while deleting the team.", 'error');
                    }
                },
                'btn-danger'
            );
        }






        // EDIT USER
        async function editUser(userId) {
            const res = await fetch(`/api/admin/user/${userId}`);
            if (res.ok) {
                const data = await res.json();
                const form = document.getElementById('editUserForm');
                form.action = `/admin/edit-account/${userId}`;

                document.getElementById('editUserName').value = data.name;
                // Add Ultra Admin option if not present and data is ultra_admin
                const roleSelect = document.getElementById('editUserRole');
                if (data.role === 'ultra_admin' && !Array.from(roleSelect.options).some(o => o.value === 'ultra_admin')) {
                    const opt = document.createElement('option');
                    opt.value = 'ultra_admin';
                    opt.textContent = 'Ultra Admin (Role Transfer)';
                    roleSelect.appendChild(opt);
                }
                roleSelect.value = data.role;
                document.getElementById('editUserBio').value = data.bio || '';

                const picUrl = data.profile_picture ?
                    (data.profile_picture.startsWith('http') ? data.profile_picture : `/static/uploads/${data.profile_picture}`) :
                    `https://ui-avatars.com/api/?name=${data.name}&background=random`;
                document.getElementById('editUserPicPreview').src = picUrl;

                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
        }

        // DELETE USER
        function confirmDeleteUser(id, username) {
            document.getElementById('deleteUserId').value = id;
            document.getElementById('deleteUserNameDisplay').textContent = `@${username}`;
            const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            modal.show();
        }

        async function executeDelete() {
            const userId = document.getElementById('deleteUserId').value;
            const res = await fetch(`/admin/delete-account/${userId}`, { method: 'POST' });
            if (res.ok) {
                window.location.reload();
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to delete account');
            }
        }

        // PROMOTION REQUESTS
        // PROMOTION REQUESTS
        let pendingAction = null;
        let pendingReqId = null;

        // Use showToast from app.js instead of alert
        function alertUser(msg, type='blue') {
            if (typeof showToast === 'function') {
                showToast(msg, type === 'success' ? 'green' : (type === 'error' ? 'red' : 'blue'));
            } else {
                alert(msg);
            }
        }

        function askConfirmation(title, message, icon, action, btnClass = 'btn-primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').textContent = icon;
            const btn = document.getElementById('confirmActionBtn');
            btn.className = `btn w-100 ${btnClass}`;
            
            // Unbind previous listeners to avoid double submits (simple way)
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                modal.hide();
                action();
            };
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        function showConfirmation(title, message, icon, action, reqId, confirmBtnClass = 'btn-primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmIcon').textContent = icon;

            const btn = document.getElementById('confirmActionBtn');
            
            // Unbind previous
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.className = `btn w-100 ${confirmBtnClass}`;
            newBtn.onclick = executeConfirmation;

            pendingAction = action;
            pendingReqId = reqId;

            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        async function executeConfirmation() {
            const modalEl = document.getElementById('confirmationModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            if (!pendingAction || !pendingReqId) return;

            const url = pendingAction === 'approve'
                ? `/admin/approve-promotion/${pendingReqId}`
                : `/admin/reject-promotion/${pendingReqId}`;

            try {
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    // Small delay to allow modal to close smoothly
                    setTimeout(() => window.location.reload(), 300);
                } else {
                    alert(data.error || 'Action failed');
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }

        function approvePromotion(reqId, currentApprovals, totalAdmins) {
            // Convert to numbers
            const cur = parseInt(currentApprovals) || 0;
            const tot = parseInt(totalAdmins) || 0;
            const nextCount = cur + 1;

            showConfirmation(
                'Approve Promotion?',
                `This request has currently been approved by ${cur} out of ${tot} Super Admins.\n\nAfter your approval, it will be ${nextCount} / ${tot}.\n\nAre you sure you want to approve?`,
                '‚úÖ',
                'approve',
                reqId,
                'btn-success'
            );
        }

        function rejectPromotion(reqId) {
            showConfirmation(
                'Reject Promotion?',
                'Are you sure you want to reject this promotion request?',
                'üö´',
                'reject',
                reqId,
                'btn-danger'
            );
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            console.log("create_account.html: DOMContentLoaded triggered");
            try {
                loadSavedFilters();
            } catch (e) { console.error("Filter init failed", e); }
            
            const teamsContainer = document.getElementById('teamsListContainer');
            if (teamsContainer) {
                console.log("teamsListContainer found, starting loadTeams");
                loadTeams();
            } else {
                console.log("teamsListContainer not found, skipping loadTeams (likely regular admin)");
            }
        });
    </script>
    <div id="siteToast" class="site-toast hidden">
        <div class="toast-content">
            <span id="toastMessage"></span>
            <button class="toast-close" onclick="hideToast()">√ó</button>
        </div>
    </div>
</body>

</html>