<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Edit Customer - {{ c.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body id="page-customers"
    class="{% if current_theme and current_theme != 'light' %}theme-{{ current_theme }}{% endif %}">

    <!-- MAIN -->
    <main class="main">
        <!-- FLASH MESSAGES -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">
                <span>{{ message }}</span>
                <button onclick="this.parentElement.remove()">✕</button>
                </div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        <!-- HEADER -->
        <div class="header d-flex justify-content-between align-items-center mb-4">
            <div class="header-left">
                <a href="{{ url_for('customer_profile', id=c.id) }}" class="btn btn-gray">
                    ← Back
                </a>
                <div>
                    <h2 style="margin:0">Edit Customer</h2>
                    <div style="color: var(--gray); font-size:0.85rem;">
                        Update customer profile details
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM CARD -->
        <div class="form-center">
            <div class="card form-card">
                <form method="POST" id="editForm" novalidate>

                    <!-- FIRST NAME -->
                    <div class="form-group mb-3">
                        <label>First Name *</label>
                        <input type="text" name="firstName" class="form-control" id="firstName"
                            value="{{ c.name.split(' ')[0] }}">
                        <div class="invalid-feedback" id="firstNameError"></div>
                    </div>

                    <!-- LAST NAME -->
                    <div class="form-group mb-3">
                        <label>Last Name *</label>
                        <input type="text" name="lastName" class="form-control" id="lastName"
                            value="{{ c.name.split(' ')[1] if c.name.split(' ')|length > 1 else '' }}">
                        <div class="invalid-feedback" id="lastNameError"></div>
                    </div>

                    <!-- Hidden combined name -->
                    <input type="hidden" name="name" id="fullName">

                    <!-- EMAIL -->
                    <div class="form-group mb-3">
                        <label>Email *</label>
                        <input type="email" name="email" class="form-control" id="email" value="{{ c.email }}">
                        <div class="invalid-feedback" id="emailError"></div>
                    </div>

                    <!-- PHONE -->
                    <div class="form-group mb-3">
                        <label>Phone *</label>
                        <input type="text" name="phone" class="form-control" id="phone" value="{{ c.phone }}">
                        <div class="invalid-feedback" id="phoneError"></div>
                    </div>

                    <!-- LOCATION -->
                    <div class="form-group mb-3">
                        <label>Location</label>
                        <input type="text" name="location" class="form-control" id="location" value="{{ c.location }}">
                        <div class="invalid-feedback" id="locationError"></div>
                    </div>

                    <!-- TAGS -->
                    <div class="form-group mb-3">
                        <label>Tags</label>
                        <div class="tag-picker">
                            {% set current_tags = c.tags.split(',') if c.tags else [] %}
                            {% for tag, color in tags_inventory.items() %}
                            <label class="tag-option">
                                <input type="checkbox" name="tags" value="{{ tag }}"
                                    {% if tag in current_tags %}checked{% endif %}>
                                <span class="tag-pill-ui">{{ tag }}</span>
                            </label>
                            {% endfor %}
                        </div>

                        <input type="text" name="new_tag" class="form-control mt-2"
                            placeholder="Add new tag...">
                    </div>

                    <!-- NOTES -->
                    <div class="form-group mb-3">
                        <label>Internal Notes</label>
                        <textarea name="notes" class="form-control" id="notes" rows="4">{{ c.notes }}</textarea>
                    </div>

                    <!-- BUTTONS -->
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success" type="submit">Save Changes</button>
                        <a href="{{ url_for('customer_profile', id=c.id) }}" class="btn btn-secondary">Cancel</a>
                    </div>

                </form>
            </div>
    </main>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const customerId = {{ c.id }};
        let chatSessions = [];

        async function openLinkChatModal() {
            const modal = new bootstrap.Modal(document.getElementById('linkChatModal'));
            modal.show();

            // Fetch chat sessions
            const res = await fetch('/api/chat/sessions');
            chatSessions = await res.json();

            const select = document.getElementById('chatSessionSelect');
            const loadingMsg = document.getElementById('chatLoadingMsg');

            select.innerHTML = '<option value="">-- Select a chat --</option>';
            chatSessions.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.visitor_name} (${s.visitor_email}) - ${s.status}`;
                if (s.linked_customer_id === customerId) {
                    opt.textContent += ' ✓ Already linked';
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            loadingMsg.style.display = 'none';
        }

        async function linkToChat() {
            const select = document.getElementById('chatSessionSelect');
            const sessionId = select.value;

            if (!sessionId) {
                alert('Please select a chat session.');
                return;
            }

            await fetch(`/api/chat/session/${sessionId}/link-customer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customer_id: customerId })
            });

            alert('Customer linked to chat successfully!');
            bootstrap.Modal.getInstance(document.getElementById('linkChatModal')).hide();
        }
    </script>

    <!-- CLIENT VALIDATION -->
<script>
document.getElementById("editForm").addEventListener("submit", function(e){

    let valid = true;

    function showError(id, errorId, msg){
        const input = document.getElementById(id);
        const error = document.getElementById(errorId);

        input.classList.add("is-invalid");
        error.innerText = msg;
        valid = false;
    }

    function clearErrors(){
        document.querySelectorAll(".form-control").forEach(i=>{
            i.classList.remove("is-invalid");
        });
        document.querySelectorAll(".invalid-feedback").forEach(i=>{
            i.innerText="";
        });
    }

    clearErrors();

    const first = firstName.value.trim();
    const last = lastName.value.trim();
    const emailVal = email.value.trim();
    const phoneVal = phone.value.trim();

    const nameRegex = /^[A-Za-z\s'\-]+$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if(!first) showError("firstName","firstNameError","First name required");
    else if(!nameRegex.test(first)) showError("firstName","firstNameError","Letters only");

    if(!last) showError("lastName","lastNameError","Last name required");
    else if(!nameRegex.test(last)) showError("lastName","lastNameError","Letters only");

    if(!emailVal) showError("email","emailError","Email required");
    else if(!emailRegex.test(emailVal)) showError("email","emailError","Invalid email");

    if(!phoneVal) showError("phone","phoneError","Phone required");

    if(!valid){
        e.preventDefault();
        return;
    }

    fullName.value = first + " " + last;
});
</script>
<script>
setTimeout(() => {
    document.querySelectorAll(".flash").forEach(el => el.remove());
}, 4000);
</script>
<script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>